<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Yorck Kino Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #e6edf3;
            --primary-color: #f7b731;
            --card-bg-color: rgba(31, 41, 55, 0.5);
            --border-color: rgba(55, 65, 81, 0.7);
            --input-bg-color: #161b22;
            --highlight-bg-color: #2563eb; /* Blue 600 */
            --highlight-text-color: #ffffff;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.07) 1px, transparent 0);
            background-size: 2rem 2rem;
        }
        html, body {
            overflow-x: clip;
        }
        .glass-panel {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .form-element {
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-element:focus-within, .form-element:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(247, 183, 49, 0.4);
        }
        .filter-toggle-group input:checked + label {
            background-color: var(--color-bg, var(--highlight-bg-color));
            color: var(--color-text, var(--highlight-text-color));
            font-weight: 600;
            border-color: var(--color-bg, var(--highlight-bg-color));
        }
        .filter-toggle-group label {
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .showtime-btn {
             transition: all 0.2s ease-in-out;
             border-width: 2px;
        }
        .showtime-btn:hover {
            background-color: var(--border-color);
        }
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lazy-load-placeholder {
            background-color: var(--border-color);
            border-radius: 0.375rem;
            width: 100%;
            height: 100%;
        }
        .site-header { position: sticky; top: 0; z-index: 40; padding-top: env(safe-area-inset-top); }
        .nav-bar { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .nav-actions { display: flex; gap: 0.5rem; align-items: center; }
        .mobile-nav-button { display: inline-flex; align-items: center; justify-content: center; width: 44px; height: 44px; border-radius: 8px; }
        .mobile-menu { position: fixed; inset: 0 0 auto 0; left: 0; right: 0; top: 64px; background: linear-gradient(180deg, rgba(13,17,23,0.98), rgba(13,17,23,0.995)); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); padding: 1rem; transform-origin: top; transform: scaleY(0); transition: transform 220ms ease-in-out, opacity 220ms; opacity: 0; border-top: 1px solid var(--border-color); }
        .mobile-menu.open { transform: scaleY(1); opacity: 1; }
        .no-scroll { overflow: hidden !important; height: 100%; }
        @media (min-width: 768px) {
            .mobile-nav-button, .mobile-menu { display: none; }
            .nav-desktop { display: block; }
        }
        .header-control { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem 0.75rem; height: 44px; white-space: nowrap; border-radius: 0.5rem; }
        .header-control .form-element { height: 36px; padding: 0 0.5rem; }
        #primary-controls button, #primary-controls a { height: 44px; }
        .nav-bar { flex-wrap: nowrap; }
        /* FIX: Ensure dropdowns float above all other content */
        .dropdown-panel { position: absolute; left: 0; right: 0; top: 100%; margin-top: 0.25rem; z-index: 100; }
        @media (max-width: 767px) { .nav-bar { gap: 0.5rem; } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <header class="site-header glass-panel mb-8">
            <div class="container mx-auto p-3 nav-bar">
                <div class="flex items-center gap-3">
                    <button id="mobile-menu-btn" type="button" class="mobile-nav-button bg-gray-800 text-white md:hidden" aria-expanded="false" aria-controls="mobile-menu" aria-label="Open menu">
                        <svg id="hamburger-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    <div class="flex flex-col">
                        <h1 class="text-2xl md:text-3xl font-bold text-white mb-0">üé¨ Yorck Kino Search</h1>
                        <p class="text-xs text-gray-400">Your personal guide to the Yorck Kinos cinema program.</p>
                    </div>
                </div>
                <nav class="nav-actions nav-desktop hidden md:flex items-center" id="primary-controls">
                    <button id="fetch-btn" class="header-control bg-amber-400 text-gray-900 font-bold hover:bg-amber-500 transition-colors duration-200">Update Listings</button>
                    <button id="clear-cache-btn" class="header-control bg-gray-700 text-white font-semibold hover:bg-red-600 transition-colors duration-200 ml-3">Clear Cache</button>
                    <div id="last-updated" class="text-sm text-gray-300 ml-4">Updated: -</div>
                    <label for="emoji-input" class="text-sm font-medium text-gray-300 ml-4 mr-2">Calendar Emoji:</label>
                    <input type="text" id="emoji-input" value="üçø" class="form-element p-2 w-16 text-center" style="height:36px;">
                    <button id="emoji-toggle-btn" title="Toggle 'Unsure' Emoji" class="header-control bg-gray-700 text-white font-bold hover:bg-gray-600 transition-colors duration-200 ml-2">‚ùì</button>
                    <a href="#filters-panel" id="nav-filters-desktop" class="header-control bg-gray-800 text-gray-200 text-sm ml-4 hover:bg-gray-700">Filters</a>
                </nav>
            </div>
            <div id="mobile-menu" class="mobile-menu" role="menu" aria-hidden="true">
                <a href="#" id="nav-update-mobile" role="menuitem" class="text-white font-semibold">Update Listings</a>
                <a href="#" id="nav-filters-mobile" role="menuitem" class="text-gray-300 mt-2">Filters</a>
                <a href="#" id="nav-clear-mobile" role="menuitem" class="text-gray-300 mt-2">Clear Cache</a>
                <div class="mt-3 text-sm text-gray-300">Updated: <span id="mobile-last-updated">-</span></div>
                <div class="mt-3">
                    <label for="mobile-emoji-input" class="text-sm text-gray-300">Calendar Emoji:</label>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="text" id="mobile-emoji-input" value="üçø" class="form-element p-2 w-16 text-center">
                        <button id="mobile-emoji-toggle" class="bg-gray-700 text-white font-bold py-2 px-3 rounded-lg">‚ùì</button>
                    </div>
                </div>
                <a href="#results-container" role="menuitem" class="text-gray-300 mt-4">Results</a>
            </div>
        </header>

        <div id="initial-cta" class="glass-panel p-8 mb-6 text-center">
            <p class="text-lg text-gray-300 mb-4">Welcome ‚Äî load the Yorck website data to get started.</p>
            <button id="load-yorck-data" class="bg-amber-400 text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-amber-500 transition-colors duration-200">Load Yorck Website Data</button>
        </div>

        <div id="filters-panel" class="hidden glass-panel p-4 md:p-6 mb-6">
            <!-- ROW 1: Search, Cinema, Version, Specials -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <div id="filters-anchor" class="relative -top-2"></div>
                    <label for="search-input" class="block text-sm font-medium text-gray-300 mb-2">Search by Title</label>
                    <input type="text" id="search-input" placeholder="e.g., The Trial" class="form-element w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Cinema</label>
                    <div class="relative">
                        <button id="cinemaDropdownButton" type="button" class="w-full text-left form-element" aria-expanded="false">All Cinemas</button>
                        <div id="cinemaDropdown" class="dropdown-panel hidden bg-gray-800 rounded-md shadow-lg w-full border border-gray-700">
                            <div class="p-2 border-b border-gray-700"><input type="text" id="cinema-search-input" placeholder="Search cinema" class="form-element w-full" /></div>
                            <div class="p-2 flex justify-end border-b border-gray-700"><button id="cinema-clear-selection" class="text-sm text-amber-400 font-semibold hover:text-amber-300 disabled:text-gray-500">Clear</button></div>
                            <ul id="cinema-list" class="max-h-48 overflow-y-auto text-sm text-gray-200 p-2 space-y-1"></ul>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Language Version</label>
                    <div class="relative">
                        <button id="versionDropdownButton" type="button" class="w-full text-left form-element" aria-expanded="false">All Versions</button>
                        <div id="versionDropdown" class="dropdown-panel hidden bg-gray-800 rounded-md shadow-lg w-full border border-gray-700">
                            <div class="p-2 flex justify-end border-b border-gray-700"><button id="version-clear-selection" class="text-sm text-amber-400 font-semibold hover:text-amber-300 disabled:text-gray-500">Clear</button></div>
                            <ul id="version-list" class="max-h-48 overflow-y-auto text-sm text-gray-200 p-2 space-y-1"></ul>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Special Screenings</label>
                    <div class="relative">
                        <button id="specialsDropdownButton" type="button" class="w-full text-left form-element" aria-expanded="false">All Specials</button>
                        <div id="specialsDropdown" class="dropdown-panel hidden bg-gray-800 rounded-md shadow-lg w-full border border-gray-700">
                            <div class="p-2 flex justify-end border-b border-gray-700"><button id="specials-clear-selection" class="text-sm text-amber-400 font-semibold hover:text-amber-300 disabled:text-gray-500">Clear</button></div>
                            <ul id="specials-list" class="max-h-48 overflow-y-auto text-sm text-gray-200 p-2 space-y-1"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ROW 2: Date, Group By -->
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                <div>
                    <label for="date-filter" class="block text-sm font-medium text-gray-300 mb-2">Filter by Date</label>
                    <select id="date-filter" class="form-element w-full"></select>
                </div>
                <div>
                    <label for="group-by" class="block text-sm font-medium text-gray-300 mb-2">Group Results By</label>
                    <select id="group-by" class="form-element w-full">
                        <option value="date" selected>Date</option>
                        <option value="cinema">Cinema</option>
                        <option value="film">Film</option>
                    </select>
                </div>
            </div>
            <!-- ROW 3 & 4: Quick Toggles -->
            <div class="mt-6 space-y-4">
                <div id="time-filter" class="filter-toggle-group grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                <div id="quick-date-filter" class="filter-toggle-group grid grid-cols-3 md:grid-cols-5 gap-2"></div>
            </div>
        </div>

        <div id="status-container" class="text-center my-8"></div>
        <div id="results-container"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const elements = {
        fetchBtn: document.getElementById('fetch-btn'),
        clearCacheBtn: document.getElementById('clear-cache-btn'),
        lastUpdatedEl: document.getElementById('last-updated'),
        emojiInput: document.getElementById('emoji-input'),
        emojiToggleBtn: document.getElementById('emoji-toggle-btn'),
        statusContainer: document.getElementById('status-container'),
        resultsContainer: document.getElementById('results-container'),
        filtersPanel: document.getElementById('filters-panel'),
        searchInput: document.getElementById('search-input'),
        dateFilter: document.getElementById('date-filter'),
        timeFilterContainer: document.getElementById('time-filter'),
        groupByFilter: document.getElementById('group-by'),
    };

    const state = { 
        allSessions: [], 
        currentlyFilteredSessions: [], 
        imageObserver: null,
        selectedCinemas: ['all'],
        selectedVersions: [],
        selectedSpecials: []
    };
    const CORS_PROXY = 'https://corsproxy.io/?';
    const YORCK_PROGRAM_URL = 'https://www.yorck.de/en/films';
    
    const VERSION_DEFINITIONS = { 'DF': 'Deutsche Fassung (German Version)', 'OV': 'Originalfassung (Original Version)', 'OmU': 'Original mit Untertiteln (Original with German Subtitles)', 'OmeU': 'Original mit englischen Untertiteln (Original with English Subtitles)' };
    const STANDARD_VERSIONS = ['DF', 'OV', 'OmU', 'OmeU'];
    
    const COLOR_MAP = { 'DF': { bg: '#3b82f6', text: '#ffffff' }, 'OV': { bg: '#22c55e', text: '#ffffff' }, 'OmU': { bg: '#f97316', text: '#ffffff' }, 'OmeU': { bg: '#a855f7', text: '#ffffff' }, 'Mongay': { bg: '#ec4899', text: '#ffffff' }, 'Creepy C': { bg: '#ef4444', text: '#ffffff' }, 'InTheMood': { bg: '#14b8a6', text: '#ffffff' }, 'Sneak': { bg: '#0ea5e9', text: '#ffffff' }, 'Classic Sneak': { bg: '#6b7280', text: '#ffffff' }, 'Fetch': { bg: '#d946ef', text: '#ffffff' }, 'Torment Nexus': { bg: '#65a30d', text: '#ffffff' }, 'Cin√© Club': { bg: '#0ea5e9', text: '#ffffff' }, 'Queerfilmnacht': { bg: '#c026d3', text: '#ffffff' }, 'FILM & TALK #2030': { bg: '#475569', text: '#ffffff' }, 'Cine en Espa√±ol': { bg: '#dc2626', text: '#ffffff' }, 'Crafts Club': { bg: '#f59e0b', text: '#ffffff' }, 'Best of Cinema': { bg: '#8b5cf6', text: '#ffffff' }, 'Bis(s) zum Abspann': { bg: '#b91c1c', text: '#ffffff' }, 'Boulevard Noir': { bg: '#4f46e5', text: '#ffffff' }, 'Screen Legends': { bg: '#374151', text: '#ffffff' }, 'SV': { bg: '#78716c', text: '#ffffff' }, 'Festival': { bg: '#d97706', text: '#ffffff' }, 'KF': { bg: '#06b6d4', text: '#ffffff' }, 'Lesung': { bg: '#a16207', text: '#ffffff'}, 'default': { border: '#4b5563', text: '#d1d5db' } };

    function initializeApp() {
        setupEventListeners();
        setupImageObserver();
        const storedData = localStorage.getItem('yorckData');
        const mobileEmojiInput = document.getElementById('mobile-emoji-input'); if (mobileEmojiInput && elements.emojiInput) mobileEmojiInput.value = elements.emojiInput.value;
        const cta = document.getElementById('initial-cta');
        if (storedData) {
            try {
                const { films, timestamp } = JSON.parse(storedData);
                processRawData(films);
                elements.lastUpdatedEl.textContent = `Updated: ${formatTimestamp(timestamp)}`;
                const mobileLast = document.getElementById('mobile-last-updated'); if (mobileLast) mobileLast.textContent = formatTimestamp(timestamp);
                setupFilters();
                elements.filtersPanel.classList.remove('hidden');
                renderFilteredResults();
                if (cta) cta.style.display = 'none';
            } catch (e) {
                localStorage.removeItem('yorckData');
                showStatus('Could not load stored data. Please update listings.', 'error');
            }
        } else {
            showStatus('No data found. Click "Update Listings" to fetch the cinema program.', 'info');
            if (cta) cta.style.display = 'block';
        }
    }
    
    function setupEventListeners() {
        elements.fetchBtn?.addEventListener('click', handleFetchAll);
        elements.clearCacheBtn?.addEventListener('click', () => { localStorage.removeItem('yorckData'); const cta = document.getElementById('initial-cta'); if (cta) cta.style.display = 'block'; elements.filtersPanel.classList.add('hidden'); elements.resultsContainer.innerHTML = ''; elements.lastUpdatedEl.textContent = 'Updated: -'; const mobileLast = document.getElementById('mobile-last-updated'); if (mobileLast) mobileLast.textContent = '-'; });
        elements.emojiToggleBtn?.addEventListener('click', () => {
            const currentVal = elements.emojiInput.value;
            elements.emojiInput.value = currentVal.startsWith('‚ùì') ? currentVal.substring(1) : '‚ùì' + currentVal;
        });
        const debouncedRender = debounce(renderFilteredResults, 250);
        elements.searchInput?.addEventListener('input', debouncedRender);
        [elements.dateFilter, elements.groupByFilter, elements.timeFilterContainer]
            .filter(Boolean).forEach(el => el.addEventListener('change', renderFilteredResults));
        elements.resultsContainer?.addEventListener('click', handleShowtimeClick);
    }

    function scrollToFilters() {
        const anchor = document.getElementById('filters-anchor');
        const panel = elements.filtersPanel;
        if (!anchor || !panel) return;
        panel.classList.remove('hidden');
        const header = document.querySelector('.site-header');
        const headerRect = header ? header.getBoundingClientRect() : { height: 72 };
        const top = anchor.getBoundingClientRect().top + window.pageYOffset - (headerRect.height + 8);
        window.scrollTo({ top, behavior: 'smooth' });
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu && mobileMenu.classList.contains('open')) {
            document.getElementById('mobile-menu-btn')?.click();
        }
    }

    document.getElementById('nav-filters-desktop')?.addEventListener('click', (e) => { e.preventDefault(); scrollToFilters(); });
    document.getElementById('nav-filters-mobile')?.addEventListener('click', (e) => { e.preventDefault(); scrollToFilters(); });
    document.getElementById('load-yorck-data')?.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('fetch-btn').click(); if (document.getElementById('initial-cta')) document.getElementById('initial-cta').style.display = 'none'; });

    function setupImageObserver() {
        state.imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const placeholder = entry.target;
                    const img = document.createElement('img');
                    img.src = placeholder.dataset.src;
                    img.alt = placeholder.dataset.alt;
                    img.className = 'rounded-md w-full h-full object-cover';
                    img.onload = () => placeholder.parentNode.replaceChild(img, placeholder);
                    img.onerror = () => { placeholder.style.backgroundColor = '#374151'; }
                    observer.unobserve(placeholder);
                }
            });
        }, { rootMargin: "300px 0px" });
    }

    async function handleFetchAll() {
        showStatus('', 'loading');
        elements.fetchBtn.disabled = true;
        elements.fetchBtn.textContent = 'Updating...';
        try {
            const response = await fetch(`${CORS_PROXY}${encodeURIComponent(YORCK_PROGRAM_URL)}`);
            if (!response.ok) throw new Error(`Network error: ${response.status}`);
            const htmlText = await response.text();
            const doc = new DOMParser().parseFromString(htmlText, 'text/html');
            const nextDataScript = doc.getElementById('__NEXT_DATA__');
            if (!nextDataScript) throw new Error('Scraping failed: Could not find data script.');
            const films = JSON.parse(nextDataScript.textContent).props.pageProps.films;
            if (!films) throw new Error('Scraping failed: Film data missing.');
            localStorage.setItem('yorckData', JSON.stringify({ films, timestamp: new Date().toISOString() }));
            processRawData(films);
            const nowIso = new Date().toISOString();
            elements.lastUpdatedEl.textContent = `Updated: ${formatTimestamp(nowIso)}`;
            const mobileLast2 = document.getElementById('mobile-last-updated'); if (mobileLast2) mobileLast2.textContent = formatTimestamp(nowIso);
            showStatus('Listings updated successfully!', 'success');
            setTimeout(() => elements.statusContainer.innerHTML = '', 3000);
            setupFilters();
            renderFilteredResults();
            elements.filtersPanel.classList.remove('hidden');
        } catch (error) {
            console.error('Error fetching data:', error);
            showStatus(`Failed to update listings. Error: ${error.message}`, 'error');
        } finally {
            elements.fetchBtn.disabled = false;
            elements.fetchBtn.textContent = 'Update Listings';
        }
    }

    function formatTimestamp(isoString) { try { const d = new Date(isoString); const pad = n => String(n).padStart(2, '0'); return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; } catch (e) { return isoString; } }
    function processRawData(films) { state.allSessions = films.flatMap(film => (film.fields.sessions || []).map(sessionRef => ({ film: film.fields, session: sessionRef.fields, cinema: sessionRef.fields.cinema?.fields })).filter(item => item.cinema)); }

    function setupFilters() {
        const createRadioGroup = (items, name) => items.map((item, index) => `<div><input type="radio" id="${name}-${item.value}" name="${name}" value="${item.value}" class="hidden" ${index === 0 ? 'checked' : ''}><label for="${name}-${item.value}" class="block cursor-pointer rounded-md py-2 px-4 text-center">${item.label}</label></div>`).join('');
        elements.timeFilterContainer.innerHTML = createRadioGroup([{ value: 'all', label: 'All Day' }, { value: 'morning', label: 'Morning (til 12:00)' }, { value: 'afternoon', label: 'Afternoon (12-17:00)' }, { value: 'evening', label: 'Evening (from 17:00)' }], 'time');
        const quickDateContainer = document.getElementById('quick-date-filter');
        if (quickDateContainer) {
            quickDateContainer.innerHTML = createRadioGroup([{ value: 'all', label: 'All Dates' }, { value: 'today', label: 'Today' }, { value: 'tomorrow', label: 'Tomorrow' }, { value: 'this_week', label: 'This Week' }, { value: 'next_week', label: 'Next Week' }], 'quickDate');
            quickDateContainer.addEventListener('change', renderFilteredResults);
        }

        const allFormats = [...new Set(state.allSessions.flatMap(s => s.session.formats || []))];
        const uniqueCinemas = [...new Set(state.allSessions.map(s => s.cinema.name.trim()))].sort();
        const uniqueVersions = STANDARD_VERSIONS.filter(v => allFormats.includes(v));
        const uniqueSpecials = allFormats.filter(f => !STANDARD_VERSIONS.includes(f)).sort();

        // Generic dropdown setup function
        const setupDropdown = (options) => {
            const { buttonId, dropdownId, listId, clearId, stateKey, placeholder, type } = options;
            const button = document.getElementById(buttonId);
            const dropdown = document.getElementById(dropdownId);
            const list = document.getElementById(listId);
            const clearBtn = document.getElementById(clearId);

            if (!button || !dropdown || !list) return;
            
            list.innerHTML = '';
            
            if (type === 'cinema') {
                const liAll = document.createElement('li');
                liAll.innerHTML = `<label for="cinema-all" class="flex items-center w-full p-2 rounded-md cursor-pointer hover:bg-gray-700 [&:has(input:checked)]:bg-blue-800/50"><input type="checkbox" id="cinema-all" class="mr-3 w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked><span class="font-semibold">All Cinemas</span></label>`;
                list.appendChild(liAll);
            }
            
            options.items.forEach((item, idx) => {
                const li = document.createElement('li');
                const safeId = `${type}-${idx}`;
                const color = COLOR_MAP[item]?.bg;
                const colorHtml = color ? `<span class="w-3 h-3 rounded-full mr-2" style="background-color: ${color};"></span>` : '';
                li.innerHTML = `
                    <label for="${safeId}" class="flex items-center w-full p-2 rounded-md cursor-pointer hover:bg-gray-700 [&:has(input:checked)]:bg-blue-800/50 transition-colors">
                        <input type="checkbox" id="${safeId}" class="mr-3 w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 focus:ring-2 focus:ring-offset-0" value="${item}">
                        ${colorHtml}
                        <span>${item}</span>
                    </label>`;
                list.appendChild(li);
            });

            const syncSelection = () => {
                const checkboxes = Array.from(list.querySelectorAll('input[type="checkbox"]:not(#cinema-all)'));
                const checkedItems = checkboxes.filter(cb => cb.checked).map(cb => cb.value);

                if (type === 'cinema') {
                    if (checkedItems.length === 0) {
                        state[stateKey] = ['all'];
                        const allCb = document.getElementById('cinema-all');
                        if (allCb && !allCb.checked) allCb.checked = true;
                    } else {
                        state[stateKey] = checkedItems;
                    }
                } else {
                     state[stateKey] = checkedItems;
                }

                if (state[stateKey].includes('all') || state[stateKey].length === 0) {
                    button.textContent = placeholder;
                } else if (state[stateKey].length === 1) {
                    button.textContent = state[stateKey][0];
                } else {
                    button.textContent = `${state[stateKey].length} selected`;
                }

                if (clearBtn) clearBtn.disabled = (type === 'cinema' ? state[stateKey].includes('all') : state[stateKey].length === 0);
                renderFilteredResults();
            };

            list.addEventListener('change', (e) => {
                if (e.target.type !== 'checkbox') return;
                if (type === 'cinema') {
                    const allCb = document.getElementById('cinema-all');
                    if (e.target.id === 'cinema-all' && e.target.checked) {
                        list.querySelectorAll('input:not(#cinema-all)').forEach(cb => cb.checked = false);
                    } else if (e.target.id !== 'cinema-all' && e.target.checked) {
                        if (allCb) allCb.checked = false;
                    }
                }
                syncSelection();
            });

            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    list.querySelectorAll('input:not(#cinema-all)').forEach(cb => cb.checked = false);
                    if (type === 'cinema') { const allCb = document.getElementById('cinema-all'); if(allCb) allCb.checked = true; }
                    syncSelection();
                });
            }
            
            button.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('hidden'); });
            syncSelection();
        };

        // Initialize all three dropdowns
        setupDropdown({ buttonId: 'cinemaDropdownButton', dropdownId: 'cinemaDropdown', listId: 'cinema-list', clearId: 'cinema-clear-selection', stateKey: 'selectedCinemas', placeholder: 'All Cinemas', items: uniqueCinemas, type: 'cinema' });
        setupDropdown({ buttonId: 'versionDropdownButton', dropdownId: 'versionDropdown', listId: 'version-list', clearId: 'version-clear-selection', stateKey: 'selectedVersions', placeholder: 'All Versions', items: uniqueVersions, type: 'version' });
        setupDropdown({ buttonId: 'specialsDropdownButton', dropdownId: 'specialsDropdown', listId: 'specials-list', clearId: 'specials-clear-selection', stateKey: 'selectedSpecials', placeholder: 'All Specials', items: uniqueSpecials, type: 'specials' });
        
        const cinemaSearchInput = document.getElementById('cinema-search-input');
        if (cinemaSearchInput) cinemaSearchInput.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#cinema-list li').forEach(li => { li.style.display = li.innerText.toLowerCase().includes(q) ? '' : 'none'; });
        });

        const uniqueDates = [...new Set(state.allSessions.map(s => s.session.startTime.split('T')[0]))].sort();
        elements.dateFilter.innerHTML = '<option value="all">All Dates</option>' + uniqueDates.map(dateStr => {
            const dateObj = new Date(dateStr + 'T00:00:00Z');
            return `<option value="${dateStr}">${dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', timeZone: 'UTC' })}</option>`;
        }).join('');

        document.addEventListener('click', () => { 
            document.getElementById('cinemaDropdown')?.classList.add('hidden');
            document.getElementById('versionDropdown')?.classList.add('hidden');
            document.getElementById('specialsDropdown')?.classList.add('hidden');
        });
        document.querySelectorAll('.relative').forEach(el => el.addEventListener('click', e => e.stopPropagation()));
    }
    
    function renderFilteredResults() {
        const filters = {
            search: elements.searchInput.value.toLowerCase(),
            cinema: state.selectedCinemas,
            date: elements.dateFilter.value,
            versions: state.selectedVersions,
            specials: state.selectedSpecials,
            time: elements.timeFilterContainer.querySelector(':checked')?.value || 'all',
            quickDate: document.querySelector('input[name="quickDate"]:checked')?.value || 'all'
        };

        state.currentlyFilteredSessions = state.allSessions.filter(item => {
            const sessionTime = new Date(item.session.startTime);
            const sessionHour = sessionTime.getHours();
            const itemFormats = item.session.formats || [];
            const allVersionFilters = [...filters.versions, ...filters.specials];

            const inQuickRange = (() => {
                const q = filters.quickDate; if (q === 'all') return true;
                const dayStart = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
                const today = dayStart(new Date()); const sessionDay = dayStart(sessionTime);
                if (q === 'today') return sessionDay.getTime() === today.getTime();
                if (q === 'tomorrow') { const t = new Date(today); t.setDate(t.getDate() + 1); return sessionDay.getTime() === t.getTime(); }
                const getWeekRange = (base, weekOffset = 0) => { const d = new Date(base); d.setDate(d.getDate() + weekOffset * 7); const day = d.getDay(); const monday = new Date(d); monday.setDate(d.getDate() - ((day + 6) % 7)); monday.setHours(0,0,0,0); const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23,59,59,999); return { start: monday, end: sunday }; };
                if (q === 'this_week') { const range = getWeekRange(new Date(), 0); return sessionTime >= range.start && sessionTime <= range.end; }
                if (q === 'next_week') { const range = getWeekRange(new Date(), 1); return sessionTime >= range.start && sessionTime <= range.end; }
                return true;
            })();

            if (!inQuickRange) return false;

            return (
                (!filters.search || item.film.title.toLowerCase().includes(filters.search)) &&
                (filters.cinema.includes('all') || filters.cinema.includes(item.cinema.name.trim())) &&
                (filters.date === 'all' || item.session.startTime.startsWith(filters.date)) &&
                (allVersionFilters.length === 0 || itemFormats.some(v => allVersionFilters.includes(v))) &&
                !((filters.time === 'morning' && sessionHour >= 12) || (filters.time === 'afternoon' && (sessionHour < 12 || sessionHour >= 17)) || (filters.time === 'evening' && sessionHour < 17))
            );
        });
        
        elements.statusContainer.innerHTML = '';
        elements.resultsContainer.innerHTML = '';

        if (state.currentlyFilteredSessions.length === 0) return showStatus('No showtimes match your criteria.', 'info');
        
        const groupBy = elements.groupByFilter.value;
        const renderFunction = { date: renderGroupedByDate, cinema: renderGroupedByCinema, film: renderGroupedByFilm }[groupBy];
        renderFunction(state.currentlyFilteredSessions);
        
        if (state.imageObserver) {
            elements.resultsContainer.querySelectorAll('.lazy-load-placeholder').forEach(el => state.imageObserver.observe(el));
        }
    }
    
    function createShowtimeButtons(sessions, indexMap) { return sessions.sort((a, b) => new Date(a.session.startTime) - new Date(b.session.startTime)).map(item => { const time = new Date(item.session.startTime); const format = (item.session.formats || [])[0]; const color = COLOR_MAP[format]?.bg || COLOR_MAP['default'].border; return `<button class="showtime-btn border-gray-700 bg-gray-900/50 rounded-lg p-2 text-center w-24" style="border-color:${color}" data-session-index="${indexMap.get(item)}"><span class="font-bold text-lg">${time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span><span class="block text-xs text-gray-400">${(item.session.formats || []).join(', ')}</span></button>`; }).join(''); }
    const createFilmEntryHTML = (film, sessions, indexMap) => { const posterUrl = film.heroImage?.fields?.image?.fields?.file?.url ? `https:${film.heroImage.fields.image.fields.file.url}` : 'https://via.placeholder.com/320x180.png?text=No+Image'; const filmUrl = `https://www.yorck.de/en/films/${film.slug}`; const details = [film.mainLabel, film.runtime ? `${film.runtime} min` : null, film.fsk !== null ? `FSK ${film.fsk}` : null].filter(Boolean).join(' | '); return `<div class="flex flex-col sm:flex-row gap-4 py-4 border-b border-gray-700 last:border-b-0"><a href="${filmUrl}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 w-full sm:w-64 aspect-video"><div class="lazy-load-placeholder" data-src="${posterUrl}" data-alt="${film.title} Poster"></div></a><div class="flex-grow"><a href="${filmUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline"><h5 class="text-lg font-bold text-white">${film.title}</h5></a><p class="text-sm text-gray-400 mt-1 italic">${film.tagline || ''}</p><p class="text-xs text-gray-300 font-medium mt-2">${details}</p><div class="flex flex-wrap gap-2 mt-3">${createShowtimeButtons(sessions, indexMap)}</div></div></div>`; };
    const renderGroupedBy = (sessions, primaryKeyFn, secondaryKeyFn, primaryHeaderFn, secondaryHeaderFn) => { const indexMap = new Map(sessions.map((s, i) => [s, i])); const groupedPrimary = sessions.reduce((acc, item) => { (acc[primaryKeyFn(item)] = acc[primaryKeyFn(item)] || []).push(item); return acc; }, {}); const html = Object.keys(groupedPrimary).sort().map(primaryKey => { const secondaryHTML = Object.entries(groupedPrimary[primaryKey].reduce((acc, item) => { (acc[secondaryKeyFn(item)] = acc[secondaryKeyFn(item)] || []).push(item); return acc; }, {})).sort(([a], [b]) => a.localeCompare(b)).map(([secondaryKey, secondaryItems]) => { const filmsHTML = Object.values(secondaryItems.reduce((acc, item) => { if (!acc[item.film.title]) acc[item.film.title] = { film: item.film, sessions: [] }; acc[item.film.title].sessions.push(item); return acc; }, {})).sort((a,b) => a.film.title.localeCompare(b.film.title)).map(({film, sessions}) => createFilmEntryHTML(film, sessions, indexMap)).join(''); return `<div class="glass-panel p-4 mb-4">${secondaryHeaderFn(secondaryKey)}${filmsHTML}</div>`; }).join(''); return primaryHeaderFn(primaryKey) + secondaryHTML; }).join(''); elements.resultsContainer.innerHTML = html; };
    const dateHeader = date => `<h3 class="text-2xl font-semibold text-white border-b-2 border-amber-400 pb-2 mb-6 mt-8">${new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}</h3>`;
    const cinemaHeader = name => `<h3 class="text-2xl font-semibold text-white border-b-2 border-amber-400 pb-2 mb-6 mt-8">${name}</h3>`;
    const cinemaSubHeader = name => `<h4 class="text-xl font-bold text-amber-400 mb-4">${name}</h4>`;
    const dateSubHeader = date => `<h4 class="text-xl font-bold text-amber-400 mb-4">${new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'UTC' })}</h4>`;
    const renderGroupedByDate = s => renderGroupedBy(s, i => i.session.startTime.split('T')[0], i => i.cinema.name.trim(), dateHeader, cinemaSubHeader);
    const renderGroupedByCinema = s => renderGroupedBy(s, i => i.cinema.name.trim(), i => i.session.startTime.split('T')[0], cinemaHeader, dateSubHeader);
    function renderGroupedByFilm(sessions) { const indexMap = new Map(sessions.map((s, i) => [s, i])); const groupedByFilm = sessions.reduce((acc, item) => { (acc[item.film.title] = acc[item.film.title] || []).push(item); return acc; }, {}); const html = Object.keys(groupedByFilm).sort().map(filmTitle => { const filmSessions = groupedByFilm[filmTitle]; const filmData = filmSessions[0].film; const posterUrl = filmData.heroImage?.fields?.image?.fields?.file?.url ? `https:${filmData.heroImage.fields.image.fields.file.url}` : 'https://via.placeholder.com/320x180.png?text=No+Image'; const details = [filmData.mainLabel, filmData.runtime ? `${filmData.runtime} min` : null, filmData.fsk !== null ? `FSK ${filmData.fsk}` : null].filter(Boolean).join(' | '); let filmHTML = `<div class="flex flex-col sm:flex-row gap-4 py-4 border-b-2 border-amber-400 mt-8"><a href="https://www.yorck.de/en/films/${filmData.slug}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 w-full sm:w-64 aspect-video"><div class="lazy-load-placeholder" data-src="${posterUrl}" data-alt="${filmTitle} Poster"></div></a><div class="flex-grow"><a href="https://www.yorck.de/en/films/${filmData.slug}" target="_blank" rel="noopener noreferrer" class="hover:underline"><h3 class="text-2xl font-semibold text-white">${filmTitle}</h3></a><p class="text-sm text-gray-400 mt-1 italic">${filmData.tagline || ''}</p><p class="text-xs text-gray-300 font-medium mt-2">${details}</p></div></div>`; const groupedByDate = filmSessions.reduce((acc, item) => { const date = item.session.startTime.split('T')[0]; if (!acc[date]) acc[date] = []; acc[date].push(item); return acc; }, {}); Object.keys(groupedByDate).sort().forEach(date => { filmHTML += `<h4 class="text-lg font-bold text-amber-400 mt-4 mb-2">${new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'UTC' })}</h4>`; const groupedByCinema = groupedByDate[date].reduce((acc, item) => { if (!acc[item.cinema.name]) acc[item.cinema.name] = []; acc[item.cinema.name].push(item); return acc; }, {}); Object.keys(groupedByCinema).sort().forEach(cinemaName => { filmHTML += `<div class="pl-4 border-l-2 border-gray-700 mb-3"><p class="font-semibold">${cinemaName}</p><div class="flex flex-wrap gap-2 mt-1">${createShowtimeButtons(groupedByCinema[cinemaName], indexMap)}</div></div>`; }); }); return filmHTML; }).join(''); elements.resultsContainer.innerHTML = html; }
    function handleShowtimeClick(e) { const btn = e.target.closest('.showtime-btn'); if (!btn || !btn.dataset.sessionIndex) return; const item = state.currentlyFilteredSessions[parseInt(btn.dataset.sessionIndex, 10)]; if (!item) { console.error('Session data not found'); return; } downloadIcsFile(generateIcsContent(item.film, item.session, item.cinema.name), item.film.slug, item.session.startTime); }
    function generateIcsContent(film, session, cinemaName) { const startDate = new Date(session.startTime); const endDate = new Date(startDate.getTime() + (film.runtime || 90) * 60000); const now = new Date(); const emoji = elements.emojiInput.value || 'üçø'; const formatIcsDate = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'; const formatIcsDateWithTZ = (date) => { const pad = (n) => String(n).padStart(2, '0'); return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}T${pad(date.getHours())}${pad(date.getMinutes())}${pad(date.getSeconds())}`; }; const escapeIcsText = (text) => (text || '').replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n'); const description = `Synopsis: ${escapeIcsText(film.tagline)}\\n\\nRuntime: ${film.runtime || 'N/A'} min\\nVersion: ${(session.formats || []).join(', ')}`; const filmUrl = `https://www.yorck.de/en/films/${film.slug}`; const vTimezone = ['BEGIN:VTIMEZONE', 'TZID:Europe/Berlin', 'BEGIN:DAYLIGHT', 'TZOFFSETFROM:+0100', 'TZOFFSETTO:+0200', 'TZNAME:CEST', 'DTSTART:19700329T020000', 'RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=3', 'END:DAYLIGHT', 'BEGIN:STANDARD', 'TZOFFSETFROM:+0200', 'TZOFFSETTO:+0100', 'TZNAME:CET', 'DTSTART:19701025T030000', 'RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=10', 'END:STANDARD', 'END:VTIMEZONE'].join('\r\n'); return ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//YorckPlanner//NONSGML v2.3//EN', vTimezone, 'BEGIN:VEVENT', `UID:${now.getTime()}-${film.vistaId}@yorck.de`, `DTSTAMP:${formatIcsDate(now)}`, `DTSTART;TZID=Europe/Berlin:${formatIcsDateWithTZ(startDate)}`, `DTEND;TZID=Europe/Berlin:${formatIcsDateWithTZ(endDate)}`, `SUMMARY:${escapeIcsText(`${emoji} ${film.title}`)}`, `DESCRIPTION:${description}`, `LOCATION:${escapeIcsText(cinemaName)}`, `URL;VALUE=URI:${filmUrl}`, 'END:VEVENT', 'END:VCALENDAR'].join('\r\n'); }
    function downloadIcsFile(content, filmSlug, startTime) { const date = new Date(startTime); const [y, m, d, h, min] = [date.getFullYear(), String(date.getMonth() + 1).padStart(2, '0'), String(date.getDate()).padStart(2, '0'), String(date.getHours()).padStart(2, '0'), String(date.getMinutes()).padStart(2, '0')]; const safeSlug = (filmSlug || 'film').replace(/[^a-z0-9]/gi, '-').toLowerCase(); const filename = `${y}-${m}-${d}-${h}${min}-${safeSlug}.ics`; const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); }
    function showStatus(message, type = 'info') { elements.statusContainer.innerHTML = ''; if (!message && type !== 'loading') return; const colors = { error: 'text-red-400 bg-red-900/50', success: 'text-green-300 bg-green-900/50', info: 'text-blue-300 bg-blue-900/50' }; elements.statusContainer.innerHTML = type === 'loading' ? `<div class="loader mx-auto"></div>` : `<p class="${colors[type]} p-3 rounded-lg">${message}</p>`; }
    function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
    (function setupMobileNav() { const mobileBtn = document.getElementById('mobile-menu-btn'); const mobileMenu = document.getElementById('mobile-menu'); const navUpdateMobile = document.getElementById('nav-update-mobile'); const navClearMobile = document.getElementById('nav-clear-mobile'); const mobileLastUpdated = document.getElementById('mobile-last-updated'); const mobileEmojiInput = document.getElementById('mobile-emoji-input'); const mobileEmojiToggle = document.getElementById('mobile-emoji-toggle'); const fetchBtnLocal = document.getElementById('fetch-btn'); const clearCacheLocal = document.getElementById('clear-cache-btn'); if (!mobileBtn || !mobileMenu) return; const toggleMenu = (open) => { mobileMenu.classList.toggle('open', open); mobileBtn.setAttribute('aria-expanded', open); mobileMenu.setAttribute('aria-hidden', !open); document.documentElement.classList.toggle('no-scroll', open); document.body.classList.toggle('no-scroll', open); mobileBtn.title = open ? 'Close menu' : 'Open menu'; }; mobileBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); toggleMenu(!mobileMenu.classList.contains('open')); }); mobileMenu.addEventListener('click', (e) => { if (e.target.closest('a')?.getAttribute('href') === '#') e.preventDefault(); }); document.addEventListener('click', (e) => { if (!mobileMenu.contains(e.target) && !mobileBtn.contains(e.target)) toggleMenu(false); }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape') toggleMenu(false); }); if (navUpdateMobile) navUpdateMobile.addEventListener('click', (ev) => { ev.preventDefault(); fetchBtnLocal?.click(); toggleMenu(false); }); if (navClearMobile) navClearMobile.addEventListener('click', (ev) => { ev.preventDefault(); clearCacheLocal?.click(); toggleMenu(false); }); if (mobileEmojiToggle) mobileEmojiToggle.addEventListener('click', (ev) => { ev.preventDefault(); const mainEmoji = document.getElementById('emoji-input'); if (mainEmoji) { mainEmoji.value = mainEmoji.value.startsWith('‚ùì') ? mainEmoji.value.substring(1) : '‚ùì' + mainEmoji.value; } if (mobileEmojiInput) mobileEmojiInput.value = document.getElementById('emoji-input').value; }); if (mobileEmojiInput) mobileEmojiInput.addEventListener('input', (e) => { const mainEmoji = document.getElementById('emoji-input'); if (mainEmoji) mainEmoji.value = e.target.value; }); if (fetchBtnLocal) fetchBtnLocal.addEventListener('click', () => { toggleMenu(false); const ts = new Date().toISOString(); if (mobileLastUpdated) mobileLastUpdated.textContent = formatTimestamp(ts); }); if (clearCacheLocal) clearCacheLocal.addEventListener('click', () => { toggleMenu(false); const cta = document.getElementById('initial-cta'); if (cta) cta.style.display = 'block'; if (mobileLastUpdated) mobileLastUpdated.textContent = '-'; }); })();

    initializeApp();
});
</script>

</body>
</html>

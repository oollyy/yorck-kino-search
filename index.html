<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Kino Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Font Imports for Cinema Theming --- */
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Bebas+Neue&family=Changa:wght@700&family=Cinzel:wght@700&family=Cormorant+Garamond:wght@700&family=Dancing+Script:wght@700&family=EB+Garamond:wght@700&family=Limelight&family=Lora:wght@700&family=Merriweather:wght@900&family=Oswald:wght@700&family=Parisienne&family=Poppins:wght@700&family=Roboto+Slab:wght@700&family=Special+Elite&display=swap');

        :root {
            --bg-color: #0d1117;
            --text-color: #e6edf3;
            --primary-color: #f7b731;
            --card-bg-color: rgba(31, 41, 55, 0.5);
            --border-color: rgba(55, 65, 81, 0.7);
            --input-bg-color: #161b22;
            --highlight-bg-color: #2563eb; /* Blue 600 */
            --highlight-text-color: #ffffff;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        html, body {
            overflow-x: clip;
        }
        .glass-panel {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .form-element {
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-element:focus-within, .form-element:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(247, 183, 49, 0.4);
        }
        .filter-toggle-group input:checked + label {
            background-color: var(--color-bg, var(--highlight-bg-color));
            color: var(--color-text, var(--highlight-text-color));
            font-weight: 600;
            border-color: var(--color-bg, var(--highlight-bg-color));
        }
        .filter-toggle-group label {
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .view-toggle-group button {
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg-color);
        }
        .view-toggle-group button.active {
            background-color: var(--highlight-bg-color);
            color: var(--highlight-text-color);
            font-weight: 600;
            border-color: var(--highlight-bg-color);
        }
        .showtime-btn {
             transition: all 0.2s ease-in-out;
             border-width: 2px;
        }
        .showtime-btn:hover {
            background-color: var(--border-color);
        }
        .loader {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .lazy-load-placeholder {
            background-color: var(--border-color);
            border-radius: 0.375rem;
            width: 100%;
            height: 100%;
        }
        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 40;
            padding-top: env(safe-area-inset-top);
            transition: height 0.3s ease-in-out;
        }
        .nav-bar { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .nav-actions { display: flex; gap: 0.5rem; align-items: center; }
        .header-control { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem 0.75rem; height: 44px; white-space: nowrap; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .header-control .form-element { height: 36px; padding: 0 0.5rem; }
        .nav-bar { flex-wrap: nowrap; }
        .dropdown-panel { position: absolute; left: 0; right: 0; top: 100%; margin-top: 0.25rem; z-index: 100; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            transition: all 0.2s;
        }
        .tag-pill button {
            margin-left: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
            line-height: 1;
        }
        .tag-pill button:hover {
            background: rgba(0,0,0,0.4);
        }
        .clickable-tag {
            cursor: pointer;
            transition: all 0.2s;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .clickable-tag:hover, .clickable-tag.active {
            background-color: var(--tag-color);
            color: white;
            font-weight: 600;
        }
        .detail-box-interactive {
            cursor: pointer;
            transition: all 0.2s;
        }
        .detail-box-interactive:hover, .detail-box-interactive.active {
            background-color: var(--tag-color) !important;
        }
        .detail-box-interactive:hover *, .detail-box-interactive.active * {
            color: white !important;
        }

        #main-content-wrapper {
            transition: filter 0.3s ease-in-out;
        }
        #main-content-wrapper.content-inactive {
            filter: blur(8px);
            pointer-events: none;
        }

        /* --- Cinema Theming Styles --- */
        .cinema-header-wrapper {
             border-bottom: 2px solid var(--primary-color);
             padding-bottom: 0.5rem;
             margin-bottom: 1.5rem;
             margin-top: 2rem;
        }
        .cinema-header-wrapper h3, .cinema-header-wrapper h4 {
            line-height: 1.1;
        }
        .cinema-header-wrapper h3 .cinema-name { font-size: 2.5rem; }
        .cinema-header-wrapper h4 .cinema-name { font-size: 2rem; }
        .cinema-location {
            display: block;
            font-family: sans-serif; /* Reset to a neutral font */
            font-style: italic;
            font-size: 1rem;
            color: #d1d5db; /* A slightly dimmer text color */
            margin-top: 0.25rem;
            font-weight: 400;
        }
        
        /* Font assignments */
        .cinema-theme-babylon-kreuzberg { font-family: 'Cinzel', serif; }
        .cinema-theme-blauer-stern { font-family: 'Oswald', sans-serif; text-transform: uppercase; }
        .cinema-theme-capitol-dahlem { font-family: 'Cormorant Garamond', serif; }
        .cinema-theme-cinema-paris { font-family: 'Parisienne', cursive; font-size: 3.5rem !important; }
        .cinema-theme-delphi-filmpalast { font-family: 'Limelight', cursive; letter-spacing: 0.05em; }
        .cinema-theme-delphi-lux { font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 0.1em; }
        .cinema-theme-filmtheater-am-friedrichshain { font-family: 'Anton', sans-serif; text-transform: uppercase; letter-spacing: 0.05em;}
        .cinema-theme-kant-kino { font-family: 'Roboto Slab', serif; }
        .cinema-theme-kino-international { font-family: 'Bebas Neue', cursive; letter-spacing: 0.1em; }
        .cinema-theme-neues-off { font-family: 'Special Elite', cursive; }
        .cinema-theme-odeon { font-family: 'Merriweather', serif; }
        .cinema-theme-passage { font-family: 'EB Garamond', serif; }
        .cinema-theme-rollberg { font-family: 'Changa', sans-serif; text-transform: uppercase; }
        .cinema-theme-yorck { font-family: 'Lora', serif; }


        /* --- Mobile Navigation Panel Styles --- */
        .mobile-nav-button { display: none; }
        #mobile-nav-container { position: fixed; inset: 0; z-index: 999; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 300ms ease-in-out; }
        #mobile-nav-container.open { opacity: 1; pointer-events: auto; }
        #mobile-nav-panel { position: absolute; bottom: 0; left: 0; right: 0; max-height: 90vh; background-color: #0a0d12; border-top: 1px solid var(--border-color); border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; transform: translateY(100%); transition: transform 300ms ease-in-out; display: flex; flex-direction: column; }
        #mobile-nav-container.open #mobile-nav-panel { transform: translateY(0); }
        #mobile-filters-mount .glass-panel { background: transparent; border: none; box-shadow: none; padding: 0 !important; margin-bottom: 0 !important; }
        .no-scroll { overflow: hidden !important; height: 100%; }

        @media (max-width: 1023px) {
            .nav-desktop { display: none; }
            .mobile-nav-button { display: inline-flex; }
        }
    </style>
</head>
<body class="font-sans">

    <header class="site-header glass-panel">
        <div class="container mx-auto p-3 nav-bar">
            <div class="flex items-center gap-3">
                <button id="mobile-panel-open-btn" type="button" class="mobile-nav-button header-control bg-gray-800 text-white" aria-label="Open menu">
                    <svg id="hamburger-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <div class="flex flex-col">
                    <h1 class="text-2xl md:text-3xl font-bold text-white mb-0">🎬 Kino Search</h1>
                    <p class="text-xs text-gray-400">Your personal guide to Berlin's cinema programs.</p>
                </div>
            </div>
            <nav class="nav-actions nav-desktop" id="primary-controls">
                <div id="last-updated" class="text-sm text-gray-300 mr-4">Updated: -</div>
                <button id="fetch-btn" class="header-control bg-gray-800 text-gray-200 hover:bg-amber-500 hover:text-gray-900">Update Listings</button>
                <button id="clear-cache-btn" class="header-control bg-gray-800 text-gray-200 hover:bg-red-600 hover:text-white ml-3">Clear</button>
                <button id="toggle-filters-btn" class="header-control bg-gray-800 text-gray-200 ml-4 hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                    Filters
                </button>
                <a href="#" id="nav-filters-desktop" class="header-control bg-gray-800 text-gray-200 ml-2 hover:bg-gray-700" title="Scroll to Top">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                </a>
            </nav>
        </div>
        <!-- The #filters-panel will be moved here by JS on desktop screens -->
    </header>

    <main id="main-content-wrapper" class="container mx-auto p-4 md:p-6 max-w-7xl">
        <div id="initial-cta" class="glass-panel p-8 mb-6 text-center">
            <p class="text-lg text-gray-300 mb-6">Welcome! Choose a cinema group to load their program.</p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                 <button id="load-yorck-data" data-source="yorck" class="bg-amber-400 text-gray-900 font-bold py-3 px-8 rounded-lg hover:bg-amber-500 transition-colors duration-200 w-full md:w-auto">Load Yorck Kino Data</button>
                 <button id="load-bware-data" data-source="bware" class="bg-red-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-red-600 transition-colors duration-200 w-full md:w-auto">Load B-Ware! Ladenkino Data</button>
            </div>
        </div>

        <div id="status-container" class="text-center my-8"></div>
        <div id="results-container"></div>
    </main>
    
    <div id="filters-panel" class="hidden glass-panel p-4 md:p-6 mb-6">
        <!-- ROW 1: Title, Cinema, Genre, Version, Specials -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
            <div>
                <div id="filters-anchor" class="relative -top-2"></div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Title</label>
                <div class="relative">
                    <button id="titleDropdownButton" type="button" class="w-full text-left form-element" aria-expanded="false">All Films</button>
                    <div id="titleDropdown" class="dropdown-panel hidden bg-gray-800 rounded-md shadow-lg w-full border border-gray-700">
                        <div class="p-2 border-b border-gray-700"><input type="text" id="title-search-input" placeholder="Search title..." class="form-element w-full" /></div>
                        <div class="p-2 flex justify-end border-b border-gray-700"><button id="title-clear-selection" class="text-sm text-amber-400 font-semibold hover:text-amber-300 disabled:text-gray-500">Clear</button></div>
                        <ul id="title-list" class="max-h-60 overflow-y-auto text-sm text-gray-200 p-2 space-y-1"></ul>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Cinema</label>
                <div class="relative">
                    <button id="cinemaDropdownButton" type="button" class="w-full text-left form-element" aria-expanded="false">All Cinemas</button>
                    <div id="cinemaDropdown" class="dropdown-panel hidden bg-gray-800 rounded-md shadow-lg w-full border border-gray-700">
                        <div class="p-2 border-b border-gray-700"><input type="text" id="cinema-search-input" placeholder="Search cinema..." class="form-element w-full" /></div>
                        <div class="p-2 flex justify-end border-b border-gray-700"><button id="cinema-clear-selection" class="text-sm text-amber-400 font-semibold hover:text-amber-300 disabled:text-gray-500">Clear</button></div>
                        <ul id="cinema-list" class="max-h-60 overflow-y-auto text-sm text-gray-200 p-2 space-y-1"></ul>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Filter by Genre</label>
                <div class="relative">
                    <button id="genreDropdownButton" type="button" class="w-full text-left form-element" aria-expanded="false">All Genres</button>
                    <div id="genreDropdown" class="dropdown-panel hidden bg-gray-800 rounded-md shadow-lg w-full border border-gray-700">
                        <div class="p-2 border-b border-gray-700"><input type="text" id="genre-search-input" placeholder="Search genre..." class="form-element w-full" /></div>
                        <div class="p-2 flex justify-end border-b border-gray-700"><button id="genre-clear-selection" class="text-sm text-amber-400 font-semibold hover:text-amber-300 disabled:text-gray-500">Clear</button></div>
                        <ul id="genre-list" class="max-h-60 overflow-y-auto text-sm text-gray-200 p-2 space-y-1"></ul>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Language Version</label>
                <div class="relative">
                    <button id="versionDropdownButton" type="button" class="w-full text-left form-element" aria-expanded="false">All Versions</button>
                    <div id="versionDropdown" class="dropdown-panel hidden bg-gray-800 rounded-md shadow-lg w-full border border-gray-700">
                        <div class="p-2 flex justify-end border-b border-gray-700"><button id="version-clear-selection" class="text-sm text-amber-400 font-semibold hover:text-amber-300 disabled:text-gray-500">Clear</button></div>
                        <ul id="version-list" class="max-h-60 overflow-y-auto text-sm text-gray-200 p-2 space-y-1"></ul>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Special Screenings</label>
                <div class="relative">
                    <button id="specialsDropdownButton" type="button" class="w-full text-left form-element" aria-expanded="false">All Specials</button>
                    <div id="specialsDropdown" class="dropdown-panel hidden bg-gray-800 rounded-md shadow-lg w-full border border-gray-700">
                        <div class="p-2 flex justify-end border-b border-gray-700"><button id="specials-clear-selection" class="text-sm text-amber-400 font-semibold hover:text-amber-300 disabled:text-gray-500">Clear</button></div>
                        <ul id="specials-list" class="max-h-72 overflow-y-auto text-sm text-gray-200 p-2 space-y-1"></ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-6 space-y-4">
            <div id="time-filter" class="filter-toggle-group grid grid-cols-2 md:grid-cols-4 gap-2"></div>
            <div id="quick-date-filter" class="filter-toggle-group grid grid-cols-3 md:grid-cols-6 gap-2"></div>
            <div class="flex flex-wrap items-center justify-between gap-4 pt-4 mt-4 border-t border-gray-700/50">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        <label class="text-sm font-medium text-gray-300">View by</label>
                    </div>
                    <div id="view-toggle" class="view-toggle-group flex items-center gap-2">
                        <button data-view="film" class="px-3 py-2 rounded-md flex items-center justify-center gap-2" title="Group by Film">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
                            <span class="text-sm pointer-events-none">Film</span>
                        </button>
                        <button data-view="date" class="px-3 py-2 rounded-md flex items-center justify-center gap-2" title="Group by Date">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            <span class="text-sm pointer-events-none">Date</span>
                        </button>
                        <button data-view="cinema" class="px-3 py-2 rounded-md flex items-center justify-center gap-2" title="Group by Cinema">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/><path d="M20 5H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/><path d="M12 22V9"/></svg>
                            <span class="text-sm pointer-events-none">Cinema</span>
                        </button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <label for="emoji-input" class="text-sm font-medium text-gray-300">Emoji</label>
                    <input type="text" id="emoji-input" value="🍿" class="form-element p-2 w-16 text-center" style="height:36px;">
                    <button id="emoji-toggle-btn" title="Toggle 'Unsure' Emoji" class="header-control bg-gray-700 text-white font-bold hover:bg-gray-600">❓</button>
                </div>
            </div>
            <div id="tag-filter-container" class="hidden flex flex-wrap items-center justify-between gap-4 pt-4 mt-4 border-t border-gray-700/50">
                <div id="tag-display-area" class="flex flex-wrap items-center gap-2 flex-grow"></div>
                <button id="clear-tags-btn" class="header-control bg-gray-700 text-white font-semibold hover:bg-red-600 text-sm" style="height: 36px;">Clear Tags</button>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation Panel -->
    <div id="mobile-nav-container">
        <div id="mobile-nav-panel">
            <header class="p-4 flex justify-between items-center border-b border-gray-700 flex-shrink-0">
                <h2 class="text-xl font-bold">Filters & Settings</h2>
                <button id="mobile-panel-close-btn" class="p-2" aria-label="Close menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </header>
            <div class="overflow-y-auto p-4">
                <div class="grid grid-cols-2 gap-4 mb-6">
                     <button id="mobile-fetch-btn" class="header-control bg-amber-400 text-gray-900 font-bold hover:bg-amber-500 justify-center">Update Listings</button>
                    <button id="mobile-clear-cache-btn" class="header-control bg-gray-700 text-white font-semibold hover:bg-red-600 justify-center">Clear</button>
                </div>
                <div id="mobile-filters-mount"></div>
            </div>
            <footer class="p-4 border-t border-gray-700 flex-shrink-0">
                <button id="mobile-scroll-top-btn" class="w-full header-control bg-gray-800 text-white font-semibold hover:bg-gray-700 justify-center">
                    Return to Top ↑
                </button>
            </footer>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    const elements = {
        fetchBtn: document.getElementById('fetch-btn'),
        clearCacheBtn: document.getElementById('clear-cache-btn'),
        lastUpdatedEl: document.getElementById('last-updated'),
        emojiInput: document.getElementById('emoji-input'),
        emojiToggleBtn: document.getElementById('emoji-toggle-btn'),
        statusContainer: document.getElementById('status-container'),
        resultsContainer: document.getElementById('results-container'),
        filtersPanel: document.getElementById('filters-panel'),
        timeFilterContainer: document.getElementById('time-filter'),
        viewToggle: document.getElementById('view-toggle'),
        tagFilterContainer: document.getElementById('tag-filter-container'),
        tagDisplayArea: document.getElementById('tag-display-area'),
        clearTagsBtn: document.getElementById('clear-tags-btn'),
        toggleFiltersBtn: document.getElementById('toggle-filters-btn'),
        header: document.querySelector('.site-header'),
        mainContent: document.getElementById('main-content-wrapper'),
        initialCta: document.getElementById('initial-cta')
    };

    const state = { 
        allSessions: [], 
        currentlyFilteredSessions: [], 
        imageObserver: null,
        groupBy: 'film',
        activeSource: null,
        selectedTitles: [],
        selectedCinemas: ['all'],
        selectedGenres: [],
        selectedVersions: [],
        selectedSpecials: [],
        activeTags: [],
    };
    
    // --- Data Sources ---
    const CORS_PROXY = 'https://corsproxy.io/?';
    const YORCK_PROGRAM_URL = 'https://www.yorck.de/en/films';
    const BWARE_API_URL = 'https://www.kinoheld.de/ajax/getShowsForCinemas?cinemaIds[]=108&lang=de';

    const VERSION_DEFINITIONS = { 'DF': 'Deutsche Fassung (German Version)', 'OV': 'Originalfassung (Original Version)', 'OmU': 'Original mit Untertiteln (Original with German Subtitles)', 'OmeU': 'Original mit englischen Untertiteln (Original with English Subtitles)' };
    const STANDARD_VERSIONS = ['DF', 'OV', 'OmU', 'OmeU'];
    
    const COLOR_MAP = { 'DF': { bg: '#3b82f6', text: '#ffffff' }, 'OV': { bg: '#22c55e', text: '#ffffff' }, 'OmU': { bg: '#f97316', text: '#ffffff' }, 'OmeU': { bg: '#a855f7', text: '#ffffff' }, 'OmdU': { bg: '#f97316', text: '#ffffff' }, 'Mongay': { bg: '#ec4899', text: '#ffffff' }, 'Creepy C': { bg: '#ef4444', text: '#ffffff' }, 'InTheMood': { bg: '#14b8a6', text: '#ffffff' }, 'Sneak': { bg: '#0ea5e9', text: '#ffffff' }, 'Classic Sneak': { bg: '#6b7280', text: '#ffffff' }, 'Fetch': { bg: '#d946ef', text: '#ffffff' }, 'Torment Nexus': { bg: '#65a30d', text: '#ffffff' }, 'Ciné Club': { bg: '#0ea5e9', text: '#ffffff' }, 'Queerfilmnacht': { bg: '#c026d3', text: '#ffffff' }, 'FILM & TALK #2030': { bg: '#475569', text: '#ffffff' }, 'Cine en Español': { bg: '#dc2626', text: '#ffffff' }, 'Crafts Club': { bg: '#f59e0b', text: '#ffffff' }, 'Best of Cinema': { bg: '#8b5cf6', text: '#ffffff' }, 'Bis(s) zum Abspann': { bg: '#b91c1c', text: '#ffffff' }, 'Boulevard Noir': { bg: '#4f46e5', text: '#ffffff' }, 'Screen Legends': { bg: '#374151', text: '#ffffff' }, 'SV': { bg: '#78716c', text: '#ffffff' }, 'Festival': { bg: '#d97706', text: '#ffffff' }, 'KF': { bg: '#06b6d4', text: '#ffffff' }, 'Lesung': { bg: '#a16207', text: '#ffffff'}, 'default': { border: '#4b5563', text: '#d1d5db' } };
    const TAG_COLOR_MAP = { year: '#be123c', country: '#0e7490', language: '#581c87', director: '#b45309', cast: '#166534', writer: '#374151' };

    const CINEMA_THEMES = {
        "Babylon Kreuzberg": { location: "Kreuzberg", cssClass: "cinema-theme-babylon-kreuzberg" },
        "Blauer Stern": { location: "Pankow", cssClass: "cinema-theme-blauer-stern" },
        "Capitol Dahlem": { location: "Dahlem", cssClass: "cinema-theme-capitol-dahlem" },
        "Cinema Paris": { location: "Charlottenburg", cssClass: "cinema-theme-cinema-paris" },
        "Delphi Filmpalast": { location: "Charlottenburg", cssClass: "cinema-theme-delphi-filmpalast" },
        "delphi LUX": { location: "Charlottenburg", cssClass: "cinema-theme-delphi-lux" },
        "Filmtheater am Friedrichshain": { location: "Prenzlauer Berg", cssClass: "cinema-theme-filmtheater-am-friedrichshain" },
        "Kant Kino": { location: "Charlottenburg", cssClass: "cinema-theme-kant-kino" },
        "Kino International": { location: "Mitte", cssClass: "cinema-theme-kino-international" },
        "Neues Off": { location: "Neukölln", cssClass: "cinema-theme-neues-off" },
        "Odeon": { location: "Schöneberg", cssClass: "cinema-theme-odeon" },
        "Passage": { location: "Neukölln", cssClass: "cinema-theme-passage" },
        "Rollberg": { location: "Neukölln", cssClass: "cinema-theme-rollberg" },
        "Yorck": { location: "Kreuzberg", cssClass: "cinema-theme-yorck" },
        "b-ware! Ladenkino": { location: "Friedrichshain", cssClass: "cinema-theme-neues-off" }
    };

    function setMainContentMargin() {
        if (elements.header && elements.mainContent) {
            const headerHeight = elements.header.offsetHeight;
            elements.mainContent.style.marginTop = `${headerHeight + 32}px`;
        }
    }

    function initializeApp() {
        manageFilterPanelLayout();
        setupEventListeners();
        setupImageObserver();
        setMainContentMargin();

        const lastSource = localStorage.getItem('activeSource');
        if (lastSource) {
            const storedData = localStorage.getItem(`${lastSource}Data`);
            if (storedData) {
                try {
                    const { data, timestamp } = JSON.parse(storedData);
                    state.activeSource = lastSource;
                    state.allSessions = data;
                    elements.lastUpdatedEl.textContent = `Updated: ${formatTimestamp(timestamp)}`;
                    elements.initialCta.style.display = 'none';
                    setupFilters();
                    renderFilteredResults();
                } catch (e) {
                    clearAllData();
                    showStatus('Could not load stored data. Please update listings.', 'error');
                }
            }
        } else {
            showStatus('No data found. Please select a cinema to load the program.', 'info');
            elements.initialCta.style.display = 'block';
        }
    }
    
    function setupEventListeners() {
        elements.fetchBtn?.addEventListener('click', () => handleFetchRequest(state.activeSource));
        elements.clearCacheBtn?.addEventListener('click', clearAllData);
        elements.initialCta.querySelectorAll('button[data-source]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const source = e.currentTarget.dataset.source;
                elements.initialCta.style.display = 'none';
                handleFetchRequest(source);
            });
        });

        elements.emojiToggleBtn?.addEventListener('click', () => {
            elements.emojiInput.value = elements.emojiInput.value.startsWith('❓') ? elements.emojiInput.value.substring(1) : '❓' + elements.emojiInput.value;
        });
        elements.timeFilterContainer?.addEventListener('change', renderFilteredResults);
        elements.viewToggle?.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-view]');
            if (!button) return;
            state.groupBy = button.dataset.view;
            elements.viewToggle.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            renderFilteredResults();
        });
        elements.resultsContainer?.addEventListener('click', handleShowtimeClick);
        elements.resultsContainer?.addEventListener('click', handleTagClick);
        elements.tagDisplayArea?.addEventListener('click', handleRemoveTagClick);
        elements.clearTagsBtn?.addEventListener('click', clearAllTags);
        
        elements.toggleFiltersBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = elements.filtersPanel.classList.toggle('hidden');
            elements.mainContent.classList.toggle('content-inactive', !isHidden);
            setTimeout(setMainContentMargin, 50);
        });

        window.addEventListener('resize', debounce(() => {
            manageFilterPanelLayout();
            setMainContentMargin();
        }, 200));
        
        setupMobileNav();

        document.addEventListener('click', (e) => {
            const allDropdowns = document.querySelectorAll('.dropdown-panel');
            allDropdowns.forEach(d => {
                if (!d.contains(e.target) && !d.previousElementSibling.contains(e.target)) {
                    d.classList.add('hidden');
                }
            });
            if (window.innerWidth >= 1023 && elements.filtersPanel && !elements.filtersPanel.classList.contains('hidden')) {
                if (!elements.filtersPanel.contains(e.target) && !elements.toggleFiltersBtn.contains(e.target)) {
                    elements.filtersPanel.classList.add('hidden');
                    elements.mainContent.classList.remove('content-inactive');
                    setTimeout(setMainContentMargin, 50);
                }
            }
        });
    }

    function clearAllData() {
        localStorage.removeItem('yorckData');
        localStorage.removeItem('bwareData');
        localStorage.removeItem('activeSource');
        elements.initialCta.style.display = 'block';
        elements.filtersPanel.classList.add('hidden');
        elements.resultsContainer.innerHTML = '';
        elements.lastUpdatedEl.textContent = 'Updated: -';
        state.allSessions = [];
        state.activeSource = null;
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('nav-filters-desktop')?.addEventListener('click', (e) => { e.preventDefault(); scrollToTop(); });

    function setupImageObserver() {
        state.imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const placeholder = entry.target;
                    const img = document.createElement('img');
                    img.src = placeholder.dataset.src;
                    img.alt = placeholder.dataset.alt;
                    img.className = 'rounded-md w-full h-full object-cover';
                    img.onload = () => placeholder.parentNode.replaceChild(img, placeholder);
                    img.onerror = () => { placeholder.style.backgroundColor = '#374151'; }
                    observer.unobserve(placeholder);
                }
            });
        }, { rootMargin: "300px 0px" });
    }
    
    // --- Main Fetch Dispatcher ---
    async function handleFetchRequest(source) {
        if (!source) {
            showStatus('No cinema source selected. Please choose one from the main page.', 'error');
            return;
        }
        showStatus(`Fetching listings for ${source}...`, 'loading');
        if (elements.fetchBtn) { elements.fetchBtn.disabled = true; elements.fetchBtn.textContent = 'Updating...'; }

        try {
            let data;
            if (source === 'yorck') {
                data = await fetchYorckData();
            } else if (source === 'bware') {
                data = await fetchBWareData();
            } else {
                throw new Error('Unknown data source');
            }

            state.allSessions = data;
            state.activeSource = source;
            const timestamp = new Date().toISOString();
            localStorage.setItem(`${source}Data`, JSON.stringify({ data, timestamp }));
            localStorage.setItem('activeSource', source);

            if (elements.lastUpdatedEl) elements.lastUpdatedEl.textContent = `Updated: ${formatTimestamp(timestamp)}`;
            showStatus('Listings updated successfully!', 'success');
            setTimeout(() => elements.statusContainer.innerHTML = '', 3000);
            
            setupFilters();
            renderFilteredResults();
        } catch (error) {
            console.error('Error fetching data:', error);
            showStatus(`Failed to update listings. Error: ${error.message}`, 'error');
        } finally {
            if (elements.fetchBtn) { elements.fetchBtn.disabled = false; elements.fetchBtn.textContent = 'Update Listings'; }
        }
    }
    
    // --- B-Ware! Ladenkino Data Fetching & Processing ---
    async function fetchBWareData() {
        const response = await fetch(`${CORS_PROXY}${encodeURIComponent(BWARE_API_URL)}`);
        if (!response.ok) throw new Error(`Network error: ${response.status}`);
        const rawData = await response.json();
        return processBWareData(rawData);
    }

    function processBWareData(data) {
        const moviesMap = new Map();
        for (const movieId in data.movies) {
            const movieData = data.movies[movieId];
            const film = {
                title: movieData.name,
                slug: movieData.id,
                runtime: movieData.duration,
                tagline: movieData.short_description,
                mainLabel: movieData.genres?.[0]?.name,
                heroImage: { fields: { image: { fields: { file: { url: movieData.lazyImage } } } } },
                extraDetails: {
                    longDescription: movieData.description,
                    director: movieData.directors?.map(d => d.name).join(', '),
                    fullCast: movieData.actors?.map(a => a.name).join(', '),
                    country: movieData.productionCountries?.join(', '),
                    year: movieData.released ? new Date(movieData.released).getFullYear() : null,
                    originalLanguage: null,
                    writers: null // Explicitly set writers to null
                }
            };
            moviesMap.set(movieId, film);
        }

        const auditoriumMap = {
            1267: "Saal 1: Romy Royal",
            2705: "Saal 2: Petit Titan",
            2707: "Saal 3: Wohnzimmer",
            3267: "FMP",
            3387: "vor wien",
            3439: "Prinzessinnengärten"
        };

        return data.shows.map(show => {
            const film = moviesMap.get(show.movieId.toString());
            const session = {
                startTime: show.beginning.isoFull,
                formats: show.flags.map(f => f.name)
            };
            const cinema = {
                name: 'b-ware! Ladenkino',
                auditorium: auditoriumMap[show.auditoriumId] || 'Unknown Saal'
            };
            return { film, session, cinema };
        });
    }

    // --- Yorck Kino Data Fetching & Processing ---
    async function fetchYorckData() {
        showStatus('Fetching film listings...', 'loading');
        const response = await fetch(`${CORS_PROXY}${encodeURIComponent(YORCK_PROGRAM_URL)}`);
        if (!response.ok) throw new Error(`Network error: ${response.status}`);
        
        const htmlText = await response.text();
        const doc = new DOMParser().parseFromString(htmlText, 'text/html');
        const filmsData = JSON.parse(doc.getElementById('__NEXT_DATA__').textContent).props.pageProps.films;
        if (!filmsData) throw new Error('Scraping failed: Film data missing.');

        const uniqueFilms = Object.values(filmsData.reduce((acc, film) => {
            if (film.fields.slug && !acc[film.fields.slug]) acc[film.fields.slug] = film;
            return acc;
        }, {}));
        
        const detailPromises = uniqueFilms.map((film, index) => {
            showStatus(`Fetching details for ${film.fields.title} (${index + 1}/${uniqueFilms.length})...`, 'loading');
            return fetchFilmDetails(film.fields.slug);
        });

        const allDetails = await Promise.all(detailPromises);
        const detailsMap = new Map(uniqueFilms.map((film, i) => [film.fields.slug, allDetails[i]]));

        filmsData.forEach(film => {
            const details = detailsMap.get(film.fields.slug);
            if (details) film.fields.extraDetails = details;
        });

        return processYorckData(filmsData);
    }
    
    async function fetchFilmDetails(filmSlug) {
        try {
            const filmUrl = `${CORS_PROXY}${encodeURIComponent(`https://www.yorck.de/en/films/${filmSlug}`)}`;
            const response = await fetch(filmUrl);
            if (!response.ok) return null;
            
            const htmlText = await response.text();
            const doc = new DOMParser().parseFromString(htmlText, 'text/html');
            const nextDataScript = doc.getElementById('__NEXT_DATA__');
            if (!nextDataScript) return null;
            
            const jsonData = JSON.parse(nextDataScript.textContent);
            const filmData = jsonData?.props?.pageProps?.film?.fields;
            if (!filmData) return null;

            return {
                longDescription: filmData.about ? filmData.about.replace(/<\/?p>/g, '') : (filmData.tagline || ''),
                director: filmData.director,
                fullCast: filmData.cast,
                country: filmData.countries ? filmData.countries.join(', ') : '',
                year: filmData.year,
                writers: filmData.writer,
                originalLanguage: filmData.originalLanguage
            };
        } catch (error) {
            console.warn(`Failed to fetch and parse details for ${filmSlug}:`, error);
            return null;
        }
    }
    
    function processYorckData(films) {
        return films.flatMap(film => 
            (film.fields.sessions || []).map(sessionRef => ({ 
                film: film.fields, 
                session: sessionRef.fields, 
                cinema: sessionRef.fields.cinema?.fields 
            })).filter(item => item.cinema)
        );
    }
    
    // --- Common Functions (mostly unchanged) ---
    function formatTimestamp(isoString) { try { const d = new Date(isoString); const pad = n => String(n).padStart(2, '0'); return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; } catch (e) { return isoString; } }

    function setupFilters() {
        const createRadioGroup = (items, name) => items.map((item, index) => `<div><input type="radio" id="${name}-${item.value}" name="${name}" value="${item.value}" class="hidden" ${index === 0 ? 'checked' : ''}><label for="${name}-${item.value}" class="block cursor-pointer rounded-md py-2 px-4 text-center">${item.label}</label></div>`).join('');
        elements.timeFilterContainer.innerHTML = createRadioGroup([{ value: 'all', label: 'All Day' }, { value: 'morning', label: 'Morning (til 12:00)' }, { value: 'afternoon', label: 'Afternoon (12-17:00)' }, { value: 'evening', label: 'Evening (from 17:00)' }], 'time');
        const quickDateContainer = document.getElementById('quick-date-filter');
        if (quickDateContainer) {
            quickDateContainer.innerHTML = createRadioGroup([{ value: 'all', label: 'All' }, { value: 'today', label: 'Today' }, { value: 'tomorrow', label: 'Tomorrow' }, { value: 'this_week', label: 'This Week' }, { value: 'next_week', label: 'Next Week' }, { value: 'future', label: 'Future' }], 'quickDate');
            quickDateContainer.addEventListener('change', renderFilteredResults);
        }
        
        elements.viewToggle?.querySelector(`button[data-view="${state.groupBy}"]`)?.classList.add('active');

        const allFormats = [...new Set(state.allSessions.flatMap(s => s.session.formats || []))];
        const uniqueTitles = [...new Set(state.allSessions.map(s => s.film.title))].sort();
        const uniqueCinemas = [...new Set(state.allSessions.map(s => s.cinema.name.trim()))].sort();
        const uniqueGenres = [...new Set(state.allSessions.map(s => s.film.mainLabel).filter(g => g))].sort();
        
        let uniqueVersions, uniqueSpecials;
        if (state.activeSource === 'bware') {
            uniqueVersions = [...new Set(allFormats.filter(f => ['OmdU', 'OmeU', 'OV'].includes(f)))];
            uniqueSpecials = allFormats.filter(f => !uniqueVersions.includes(f)).sort();
        } else {
            uniqueVersions = STANDARD_VERSIONS.filter(v => allFormats.includes(v));
            uniqueSpecials = allFormats.filter(f => !STANDARD_VERSIONS.includes(f)).sort();
        }

        const setupDropdown = (options) => {
            const { buttonId, dropdownId, listId, clearId, searchId, stateKey, placeholder, type } = options;
            const button = document.getElementById(buttonId); const dropdown = document.getElementById(dropdownId); const list = document.getElementById(listId); const clearBtn = document.getElementById(clearId); if (!button || !dropdown || !list) return;
            list.innerHTML = '';
            if (type === 'cinema') { list.innerHTML = `<label for="cinema-all" class="flex items-center w-full p-2 rounded-md cursor-pointer hover:bg-gray-700 [&:has(input:checked)]:bg-blue-800/50"><input type="checkbox" id="cinema-all" class="mr-3 w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" checked><span class="font-semibold">All Cinemas</span></label>`; }
            options.items.forEach((item, idx) => {
                const li = document.createElement('li'); const safeId = `${type}-${idx}`; const color = COLOR_MAP[item]?.bg; const colorHtml = color ? `<span class="w-3 h-3 rounded-full mr-2 flex-shrink-0" style="background-color: ${color};"></span>` : '';
                li.innerHTML = `<label for="${safeId}" class="flex items-center w-full p-2 rounded-md cursor-pointer hover:bg-gray-700 [&:has(input:checked)]:bg-blue-800/50 transition-colors"><input type="checkbox" id="${safeId}" class="mr-3 w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 focus:ring-2 focus:ring-offset-0" value="${item}">${colorHtml}<span>${item}</span></label>`;
                list.appendChild(li);
            });
            const syncSelection = () => {
                const checkedItems = Array.from(list.querySelectorAll('input[type="checkbox"]:not(#cinema-all)')).filter(cb => cb.checked).map(cb => cb.value);
                if (type === 'cinema') { state[stateKey] = checkedItems.length === 0 ? ['all'] : checkedItems; const allCb = document.getElementById('cinema-all'); if (allCb) allCb.checked = (state[stateKey][0] === 'all'); } else { state[stateKey] = checkedItems; }
                if (state[stateKey].includes('all') || state[stateKey].length === 0) { button.textContent = placeholder; } else if (state[stateKey].length === 1) { button.textContent = state[stateKey][0]; } else { button.textContent = `${state[stateKey].length} selected`; }
                if (clearBtn) clearBtn.disabled = (type === 'cinema' ? state[stateKey].includes('all') : state[stateKey].length === 0);
                renderFilteredResults();
            };
            list.addEventListener('change', (e) => {
                if (e.target.type !== 'checkbox') return;
                if (type === 'cinema') { const allCb = document.getElementById('cinema-all'); if (e.target.id === 'cinema-all' && e.target.checked) { list.querySelectorAll('input:not(#cinema-all)').forEach(cb => cb.checked = false); } else if (e.target.id !== 'cinema-all' && e.target.checked) { if (allCb) allCb.checked = false; } }
                syncSelection();
            });
            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.preventDefault(); e.stopPropagation(); list.querySelectorAll('input:not(#cinema-all)').forEach(cb => cb.checked = false);
                    if (type === 'cinema') { const allCb = document.getElementById('cinema-all'); if(allCb) allCb.checked = true; }
                    syncSelection();
                });
            }
            const searchInput = searchId ? document.getElementById(searchId) : null;
            if (searchInput) {
                 searchInput.addEventListener('input', (e) => { 
                    const query = e.target.value.toLowerCase();
                    list.querySelectorAll('li').forEach(li => {
                       const label = li.querySelector('label');
                       if (label) {
                           const text = label.textContent.toLowerCase();
                           li.style.display = text.includes(query) ? '' : 'none';
                       }
                    });
                });
            }
            button.addEventListener('click', e => { 
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
                if (searchInput) searchInput.focus();
            });
            syncSelection();
        };

        setupDropdown({ buttonId: 'titleDropdownButton', dropdownId: 'titleDropdown', listId: 'title-list', clearId: 'title-clear-selection', searchId: 'title-search-input', stateKey: 'selectedTitles', placeholder: 'All Films', items: uniqueTitles, type: 'title' });
        setupDropdown({ buttonId: 'cinemaDropdownButton', dropdownId: 'cinemaDropdown', listId: 'cinema-list', clearId: 'cinema-clear-selection', searchId: 'cinema-search-input', stateKey: 'selectedCinemas', placeholder: 'All Cinemas', items: uniqueCinemas, type: 'cinema' });
        setupDropdown({ buttonId: 'genreDropdownButton', dropdownId: 'genreDropdown', listId: 'genre-list', clearId: 'genre-clear-selection', searchId: 'genre-search-input', stateKey: 'selectedGenres', placeholder: 'All Genres', items: uniqueGenres, type: 'genre' });
        setupDropdown({ buttonId: 'versionDropdownButton', dropdownId: 'versionDropdown', listId: 'version-list', clearId: 'version-clear-selection', stateKey: 'selectedVersions', placeholder: 'All Versions', items: uniqueVersions, type: 'version' });
        setupDropdown({ buttonId: 'specialsDropdownButton', dropdownId: 'specialsDropdown', listId: 'specials-list', clearId: 'specials-clear-selection', stateKey: 'selectedSpecials', placeholder: 'All Specials', items: uniqueSpecials, type: 'specials' });
        
        elements.filtersPanel.addEventListener('click', e => e.stopPropagation());
    }

    function renderTags() {
        elements.tagDisplayArea.innerHTML = '';
        if (state.activeTags.length === 0) {
            elements.tagFilterContainer.classList.add('hidden');
            return;
        }
        elements.tagFilterContainer.classList.remove('hidden');

        state.activeTags.forEach((tag, index) => {
            const tagEl = document.createElement('div');
            tagEl.className = 'tag-pill';
            tagEl.style.backgroundColor = TAG_COLOR_MAP[tag.type] || '#6b7280';
            tagEl.innerHTML = `
                <span>${tag.type}: <strong>${tag.value}</strong></span>
                <button data-index="${index}" title="Remove tag">&times;</button>
            `;
            elements.tagDisplayArea.appendChild(tagEl);
        });
    }
    
    function renderFilteredResults() {
        renderTags();
        const filters = { titles: state.selectedTitles, cinema: state.selectedCinemas, genres: state.selectedGenres, versions: state.selectedVersions, specials: state.selectedSpecials, time: elements.timeFilterContainer.querySelector(':checked')?.value || 'all', quickDate: document.querySelector('input[name="quickDate"]:checked')?.value || 'all' };
        
        const filmMatchesTag = (item, tag) => {
            const extra = item.film.extraDetails || {};
            switch(tag.type) {
                case 'year': return String(extra.year) === tag.value;
                case 'country': return (extra.country || '').includes(tag.value);
                case 'language': return (extra.originalLanguage || '').includes(tag.value);
                case 'director': return (extra.director || '').includes(tag.value);
                case 'cast': return (extra.fullCast || '').includes(tag.value);
                case 'writer': return (extra.writers || '').includes(tag.value);
                default: return false;
            }
        };

        state.currentlyFilteredSessions = state.allSessions.filter(item => {
            const sessionTime = new Date(item.session.startTime); const sessionHour = sessionTime.getHours(); const itemFormats = item.session.formats || []; const itemGenre = item.film.mainLabel; const allVersionFilters = [...filters.versions, ...filters.specials];
            const inQuickRange = (() => {
                const q = filters.quickDate; if (q === 'all') return true; const dayStart = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()); const today = dayStart(new Date()); const sessionDay = dayStart(sessionTime); if (q === 'today') return sessionDay.getTime() === today.getTime(); if (q === 'tomorrow') { const t = new Date(today); t.setDate(t.getDate() + 1); return sessionDay.getTime() === t.getTime(); } const getWeekRange = (base, weekOffset = 0) => { const d = new Date(base); d.setDate(d.getDate() + weekOffset * 7); const day = d.getDay(); const monday = new Date(d); monday.setDate(d.getDate() - ((day + 6) % 7)); monday.setHours(0,0,0,0); const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23,59,59,999); return { start: monday, end: sunday }; }; if (q === 'this_week') { const range = getWeekRange(new Date(), 0); return sessionTime >= range.start && sessionTime <= range.end; } if (q === 'next_week') { const range = getWeekRange(new Date(), 1); return sessionTime >= range.start && sessionTime <= range.end; } if (q === 'future') { const range = getWeekRange(new Date(), 1); return sessionTime > range.end; } return true;
            })();
            if (!inQuickRange) return false;

            const matchesTags = state.activeTags.every(tag => filmMatchesTag(item, tag));
            if (!matchesTags) return false;

            return ((filters.titles.length === 0 || filters.titles.includes(item.film.title)) && (filters.cinema.includes('all') || filters.cinema.includes(item.cinema.name.trim())) && (filters.genres.length === 0 || (itemGenre && filters.genres.includes(itemGenre))) && (allVersionFilters.length === 0 || itemFormats.some(v => allVersionFilters.includes(v))) && !((filters.time === 'morning' && sessionHour >= 12) || (filters.time === 'afternoon' && (sessionHour < 12 || sessionHour >= 17)) || (filters.time === 'evening' && sessionHour < 17)));
        });
        elements.statusContainer.innerHTML = ''; elements.resultsContainer.innerHTML = '';
        if (state.currentlyFilteredSessions.length === 0) return showStatus('No showtimes match your criteria.', 'info');
        const groupBy = state.groupBy; const renderFunction = { date: renderGroupedByDate, cinema: renderGroupedByCinema, film: renderGroupedByFilm }[groupBy]; renderFunction(state.currentlyFilteredSessions);
        if (state.imageObserver) { elements.resultsContainer.querySelectorAll('.lazy-load-placeholder').forEach(el => state.imageObserver.observe(el)); }
    }
    
    function createShowtimeButtons(sessions, indexMap) { return sessions.sort((a, b) => new Date(a.session.startTime) - new Date(b.session.startTime)).map(item => { const time = new Date(item.session.startTime); const format = (item.session.formats || [])[0]; const color = COLOR_MAP[format]?.bg || COLOR_MAP['default'].border; return `<button class="showtime-btn border-gray-700 bg-gray-900/50 rounded-lg p-2 text-center w-24" style="border-color:${color}" data-session-index="${indexMap.get(item)}"><span class="font-bold text-lg">${time.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span><span class="block text-xs text-gray-400">${(item.session.formats || []).join(', ')}</span></button>`; }).join(''); }
    
    const createFilmHeaderHTML = (film) => {
        const posterUrl = film.heroImage?.fields?.image?.fields?.file?.url ? (film.heroImage.fields.image.fields.file.url.startsWith('https:') ? film.heroImage.fields.image.fields.file.url : `https:${film.heroImage.fields.image.fields.file.url}`) : 'https://via.placeholder.com/320x180.png?text=No+Image';
        const filmUrl = state.activeSource === 'yorck' ? `https://www.yorck.de/en/films/${film.slug}` : `https://www.kinoheld.de/kino-berlin/b-ware-ladenkino/film/${film.slug}`;

        const extraDetails = film.extraDetails || {};
        
        let imageContainerClasses = '';
        if (state.activeSource === 'bware') {
            imageContainerClasses = 'flex-shrink-0 w-full sm:w-52 aspect-[2/3]';
        } else { // yorck or default
            imageContainerClasses = 'flex-shrink-0 w-full aspect-video sm:w-72 md:w-1/3 sm:aspect-[3/2]';
        }

        const isTagActive = (type, value) => state.activeTags.some(tag => tag.type === type && tag.value === value);
        
        const createClickableList = (type, listString) => {
            if (!listString) return 'N/A';
            const terfString = "DON'T FUND TERFs";
            const modifiedListString = listString.replace(/J\.?K\.? Rowling/gi, terfString);

            return modifiedListString.split(',').map(item => item.trim()).map(value => {
                if (value === terfString) {
                    return `<span class="font-bold text-red-400 p-1">${value}</span>`;
                }
                const isActive = isTagActive(type, value);
                const tagColor = TAG_COLOR_MAP[type] || '#6b7280';
                const style = `--tag-color: ${tagColor}`;
                let classes = 'clickable-tag';
                if (isActive) classes += ' active';
                return `<span class="${classes}" data-tag-type="${type}" data-tag-value="${value}" style="${style}">${value}</span>`;
            }).join(', ');
        };

        const renderDetailBox = (label, type, value) => {
            if (!value) return '';
            
            const baseClasses = "bg-gray-800/50 p-2 rounded-md flex flex-col items-center justify-center text-center transition-colors duration-200";
            const innerHtml = `<strong class="block text-xs font-semibold text-gray-400 uppercase tracking-wider">${label}</strong><span class="text-sm">${value}</span>`;

            if (type === 'runtime') {
                return `<div class="${baseClasses}">${innerHtml}</div>`;
            }
            
            const isActive = isTagActive(type, String(value));
            const tagColor = TAG_COLOR_MAP[type] || '#6b7280';
            const style = `--tag-color: ${tagColor}`;
            let classes = `${baseClasses} detail-box-interactive`;
            if (isActive) classes += ' active';

            const clickableInnerHtml = `<strong class="block text-xs font-semibold text-gray-400 uppercase tracking-wider pointer-events-none">${label}</strong><span class="text-sm pointer-events-none">${value}</span>`;
            
            return `<div class="${classes}" data-tag-type="${type}" data-tag-value="${String(value)}" style="${style}">${clickableInnerHtml}</div>`;
        };
        
        const renderMultiDetailBox = (label, type, valueString) => {
            if (!valueString) return '';
            const values = valueString.split(',').map(s => s.trim());
            const content = values.map(value => {
                 const isActive = isTagActive(type, value);
                 const tagColor = TAG_COLOR_MAP[type] || '#6b7280';
                 const style = `--tag-color: ${tagColor}`;
                 let classes = 'clickable-tag';
                 if (isActive) classes += ' active';
                 return `<span class="${classes}" data-tag-type="${type}" data-tag-value="${value}" style="${style}">${value}</span>`;
            }).join(' ');

            return `<div class="bg-gray-800/50 p-2 rounded-md flex flex-col items-center justify-center text-center">
                        <strong class="block text-xs font-semibold text-gray-400 uppercase tracking-wider">${label}</strong>
                        <div class="text-sm flex flex-wrap gap-x-2 justify-center">${content}</div>
                    </div>`;
        }
        
        const writersHTML = extraDetails.writers
            ? `<div><strong class="font-semibold text-gray-400 block w-24 inline-block">Writer:</strong> ${createClickableList('writer', extraDetails.writers)}</div>`
            : '';

        return `
            <div class="flex flex-col sm:flex-row gap-6">
                <a href="${filmUrl}" target="_blank" rel="noopener noreferrer" class="${imageContainerClasses}">
                    <div class="lazy-load-placeholder" data-src="${posterUrl}" data-alt="${film.title} Poster"></div>
                </a>
                <div class="flex-grow flex flex-col">
                    <a href="${filmUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline">
                        <h3 class="text-2xl font-semibold text-white">${film.title}</h3>
                    </a>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3 mb-4">
                       ${renderDetailBox('Year', 'year', extraDetails.year)}
                       ${renderDetailBox('Runtime', 'runtime', film.runtime ? `${film.runtime} min` : null)}
                       ${renderMultiDetailBox('Country', 'country', extraDetails.country)}
                       ${renderMultiDetailBox('Language', 'language', extraDetails.originalLanguage)}
                    </div>
                    <p class="text-sm text-gray-300 mb-4">${extraDetails.longDescription || film.tagline || ''}</p>
                    <div class="space-y-3 text-sm mt-auto">
                        <div><strong class="font-semibold text-gray-400 block w-24 inline-block">Director:</strong> ${createClickableList('director', extraDetails.director)}</div>
                        <div><strong class="font-semibold text-gray-400 block w-24 inline-block">Cast:</strong> ${createClickableList('cast', extraDetails.fullCast)}</div>
                        ${writersHTML}
                    </div>
                </div>
            </div>`;
    };

    const renderGroupedBy = (sessions, primaryKeyFn, secondaryKeyFn, primaryHeaderFn, secondaryHeaderFn) => {
        const indexMap = new Map(sessions.map((s, i) => [s, i]));
        const groupedPrimary = sessions.reduce((acc, item) => { (acc[primaryKeyFn(item)] = acc[primaryKeyFn(item)] || []).push(item); return acc; }, {});
        const html = Object.keys(groupedPrimary).sort().map(primaryKey => {
            const secondaryHTML = Object.entries(groupedPrimary[primaryKey].reduce((acc, item) => { (acc[secondaryKeyFn(item)] = acc[secondaryKeyFn(item)] || []).push(item); return acc; }, {})).sort(([a], [b]) => a.localeCompare(b)).map(([secondaryKey, secondaryItems]) => {
                const filmsHTML = Object.values(secondaryItems.reduce((acc, item) => {
                    if (!acc[item.film.title]) acc[item.film.title] = { film: item.film, sessions: [] };
                    acc[item.film.title].sessions.push(item);
                    return acc;
                }, {})).sort((a,b) => a.film.title.localeCompare(b.film.title)).map(({film, sessions}) => {
                    const header = createFilmHeaderHTML(film);
                    const showtimes = createShowtimeButtons(sessions, indexMap);
                    return `
                        <div class="py-4 border-b border-gray-700 last:border-b-0">
                            ${header}
                            <div class="flex flex-wrap gap-2 mt-4">${showtimes}</div>
                        </div>
                    `;
                }).join('');
                return `<div class="glass-panel p-4 mb-4">${secondaryHeaderFn(secondaryKey)}${filmsHTML}</div>`;
            }).join('');
            return primaryHeaderFn(primaryKey) + secondaryHTML;
        }).join('');
        elements.resultsContainer.innerHTML = html;
    };

    function createCinemaHeaderHTML(cinemaName, level = 'h3') {
        const theme = CINEMA_THEMES[cinemaName.trim()];
        if (theme) {
            return `
                <div class="cinema-header-wrapper">
                    <${level} class="font-bold text-white">
                        <span class="cinema-name ${theme.cssClass}">${cinemaName}</span>
                        <span class="cinema-location">${theme.location}</span>
                    </${level}>
                </div>
            `;
        }
        return `<h3 class="text-2xl font-semibold text-white border-b-2 border-amber-400 pb-2 mb-6 mt-8">${cinemaName}</h3>`;
    }

    function createThemedCinemaTitleHTML(cinemaName) {
        const theme = CINEMA_THEMES[cinemaName.trim()];
        if (theme) {
            let fontSizeClass = 'text-xl';
            if (theme.cssClass === 'cinema-theme-cinema-paris') {
                fontSizeClass = 'text-3xl';
            }
            return `
                <div>
                    <div class="${theme.cssClass} ${fontSizeClass} font-bold text-white leading-tight">${cinemaName}</div>
                    <div class="text-xs italic text-gray-400 font-sans">${theme.location}</div>
                </div>
            `;
        }
        return `<p class="font-semibold">${cinemaName}</p>`;
    }

    const dateHeader = date => `<h3 class="text-2xl font-semibold text-white border-b-2 border-amber-400 pb-2 mb-6 mt-8">${new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' })}</h3>`;
    const cinemaHeader = name => createCinemaHeaderHTML(name, 'h3');
    const cinemaSubHeader = name => createCinemaHeaderHTML(name, 'h4');
    const dateSubHeader = date => `<h4 class="text-xl font-bold text-amber-400 mb-4">${new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'UTC' })}</h4>`;
    
    const renderGroupedByDate = s => renderGroupedBy(s, i => i.session.startTime.split('T')[0], i => i.cinema.name.trim(), dateHeader, cinemaSubHeader);
    const renderGroupedByCinema = s => renderGroupedBy(s, i => i.cinema.name.trim(), i => i.session.startTime.split('T')[0], cinemaHeader, dateSubHeader);

    function renderGroupedByFilm(sessions) {
        const indexMap = new Map(sessions.map((s, i) => [s, i]));
        const groupedByFilm = sessions.reduce((acc, item) => {
            (acc[item.film.title] = acc[item.film.title] || []).push(item);
            return acc;
        }, {});
    
        const html = Object.keys(groupedByFilm).sort().map(filmTitle => {
            const filmSessions = groupedByFilm[filmTitle];
            const filmData = filmSessions[0].film;
            
            let filmHTML = `<div class="border-b-2 border-amber-400 mt-8 py-4">${createFilmHeaderHTML(filmData)}</div>`;
    
            const groupedByDate = filmSessions.reduce((acc, item) => {
                const date = item.session.startTime.split('T')[0];
                if (!acc[date]) acc[date] = [];
                acc[date].push(item);
                return acc;
            }, {});
    
            let datesHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6">';
            Object.keys(groupedByDate).sort().forEach(date => {
                datesHTML += `<div class="mt-4 break-inside-avoid">
                    <h4 class="text-lg font-bold text-amber-400 mb-2">${new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'UTC' })}</h4>`;
                
                const groupedByCinema = groupedByDate[date].reduce((acc, item) => {
                    if (!acc[item.cinema.name]) acc[item.cinema.name] = [];
                    acc[item.cinema.name].push(item);
                    return acc;
                }, {});
    
                Object.keys(groupedByCinema).sort().forEach((cinemaName, index) => {
                    const bgColorClass = index % 2 === 1 ? 'bg-gray-900/40' : '';
                    datesHTML += `<div class="p-3 rounded-md mb-2 ${bgColorClass}">
                        ${createThemedCinemaTitleHTML(cinemaName)}
                        <div class="flex flex-wrap gap-2 mt-1">${createShowtimeButtons(groupedByCinema[cinemaName], indexMap)}</div>
                    </div>`;
                });
                datesHTML += '</div>';
            });
            datesHTML += '</div>';
            filmHTML += datesHTML;
    
            return filmHTML;
        }).join('');
    
        elements.resultsContainer.innerHTML = html;
    }
    function handleShowtimeClick(e) { const btn = e.target.closest('.showtime-btn'); if (!btn) return; e.stopPropagation(); const item = state.currentlyFilteredSessions[parseInt(btn.dataset.sessionIndex, 10)]; if (!item) { console.error('Session data not found'); return; } downloadIcsFile(generateIcsContent(item.film, item.session, item.cinema.name), item.film.slug, item.session.startTime); }
    
    function handleTagClick(e) {
        const tagEl = e.target.closest('[data-tag-type][data-tag-value]');
        if (!tagEl) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const newTag = {
            type: tagEl.dataset.tagType,
            value: tagEl.dataset.tagValue
        };
        
        const existingIndex = state.activeTags.findIndex(t => t.type === newTag.type && t.value === newTag.value);

        if (existingIndex > -1) {
            state.activeTags.splice(existingIndex, 1);
        } else {
            state.activeTags.push(newTag);
        }
        renderFilteredResults();
    }

    function handleRemoveTagClick(e) {
        const removeBtn = e.target.closest('button[data-index]');
        if (!removeBtn) return;
        
        const indexToRemove = parseInt(removeBtn.dataset.index, 10);
        state.activeTags.splice(indexToRemove, 1);
        renderFilteredResults();
    }

    function clearAllTags() {
        state.activeTags = [];
        renderFilteredResults();
    }

    function generateIcsContent(film, session, cinemaName) {
        const startDate = new Date(session.startTime);
        const endDate = new Date(startDate.getTime() + (film.runtime || 90) * 60000);
        const now = new Date();
        const emoji = elements.emojiInput.value || '🍿';
        const extra = film.extraDetails || {};
        
        const formatIcsDateWithTZ = (date) => { const pad = (n) => String(n).padStart(2, '0'); return `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}T${pad(date.getHours())}${pad(date.getMinutes())}${pad(date.getSeconds())}`; };
        const escapeIcsText = (text) => String(text || '').replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');

        const filmUrl = state.activeSource === 'yorck' ? `https://www.yorck.de/en/films/${film.slug}` : `https://www.kinoheld.de/kino-berlin/b-ware-ladenkino/film/${film.slug}`;

        let description = `Synopsis: ${escapeIcsText(extra.longDescription || film.tagline)}\\n\\n`;
        if (extra.director) description += `Director: ${escapeIcsText(extra.director)}\\n`;
        if (extra.writers) description += `Writer: ${escapeIcsText(extra.writers)}\\n`;
        if (extra.fullCast) description += `Cast: ${escapeIcsText(extra.fullCast)}\\n`;
        if (extra.country) description += `Country: ${escapeIcsText(extra.country)}\\n`;
        if (extra.year) description += `Year: ${escapeIcsText(extra.year)}\\n`;
        if (extra.originalLanguage) description += `Original Language: ${escapeIcsText(extra.originalLanguage)}\\n`;
        description += `Runtime: ${film.runtime || 'N/A'} min\\n`;
        description += `Version: ${(session.formats || []).join(', ')}\\n\\n`;
        description += `More Info: ${filmUrl}`;

        const vTimezone = ['BEGIN:VTIMEZONE', 'TZID:Europe/Berlin', 'BEGIN:DAYLIGHT', 'TZOFFSETFROM:+0100', 'TZOFFSETTO:+0200', 'TZNAME:CEST', 'DTSTART:19700329T020000', 'RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=3', 'END:DAYLIGHT', 'BEGIN:STANDARD', 'TZOFFSETFROM:+0200', 'TZOFFSETTO:+0100', 'TZNAME:CET', 'DTSTART:19701025T030000', 'RRULE:FREQ=YEARLY;BYDAY=-1SU;BYMONTH=10', 'END:STANDARD', 'END:VTIMEZONE'].join('\r\n');
        return ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//KinoPlanner//NONSGML v1.0//EN', vTimezone, 'BEGIN:VEVENT', `UID:${now.getTime()}-${film.slug}@kinosearch.app`, `DTSTAMP:${now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'}`, `DTSTART;TZID=Europe/Berlin:${formatIcsDateWithTZ(startDate)}`, `DTEND;TZID=Europe/Berlin:${formatIcsDateWithTZ(endDate)}`, `SUMMARY:${escapeIcsText(`${emoji} ${film.title}`)}`, `DESCRIPTION:${description}`, `LOCATION:${escapeIcsText(cinemaName)}`, `URL;VALUE=URI:${filmUrl}`, 'END:VEVENT', 'END:VCALENDAR'].join('\r\n');
    }
    function downloadIcsFile(content, filmSlug, startTime) { const date = new Date(startTime); const [y, m, d, h, min] = [date.getFullYear(), String(date.getMonth() + 1).padStart(2, '0'), String(date.getDate()).padStart(2, '0'), String(date.getHours()).padStart(2, '0'), String(date.getMinutes()).padStart(2, '0')]; const safeSlug = (filmSlug || 'film').toString().replace(/[^a-z0-9]/gi, '-').toLowerCase(); const filename = `${y}-${m}-${d}-${h}${min}-${safeSlug}.ics`; const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); }
    function showStatus(message, type = 'info') {
        elements.statusContainer.innerHTML = '';
        if (!message && type !== 'loading') return;
        const colors = { error: 'text-red-400 bg-red-900/50', success: 'text-green-300 bg-green-900/50', info: 'text-blue-300 bg-blue-900/50', loading: 'text-amber-300' };
        let content = '';
        if (type === 'loading') {
            content = `<div class="flex items-center justify-center gap-4">
                <div class="loader"></div>
                <span class="${colors.loading}">${message}</span>
            </div>`;
        } else {
            content = `<p class="${colors[type]} p-3 rounded-lg">${message}</p>`;
        }
        elements.statusContainer.innerHTML = content;
    }
    function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
    
    function manageFilterPanelLayout() {
        const filtersPanel = document.getElementById('filters-panel');
        const mobileMount = document.getElementById('mobile-filters-mount');
        if (!filtersPanel || !mobileMount) return;

        if (window.innerWidth < 1023) {
            if (!mobileMount.contains(filtersPanel)) {
                mobileMount.appendChild(filtersPanel);
                filtersPanel.classList.remove('absolute', 'top-full', 'mt-2', 'w-full', 'z-50', 'hidden');
            }
        } else {
            if (!elements.header.contains(filtersPanel)) {
                elements.header.appendChild(filtersPanel);
                filtersPanel.classList.add('absolute', 'top-full', 'mt-2', 'w-full', 'z-50');
                 if(!filtersPanel.classList.contains('hidden')) {
                    filtersPanel.classList.add('hidden');
                }
            }
        }
    }

    function setupMobileNav() {
        const container = document.getElementById('mobile-nav-container'); const openBtn = document.getElementById('mobile-panel-open-btn'); const closeBtn = document.getElementById('mobile-panel-close-btn'); const scrollTopBtn = document.getElementById('mobile-scroll-top-btn'); const mobileFetchBtn = document.getElementById('mobile-fetch-btn'); const mobileClearCacheBtn = document.getElementById('mobile-clear-cache-btn');
        if (!container || !openBtn || !closeBtn) return;
        const togglePanel = (open) => { 
            container.classList.toggle('open', open); 
            document.body.classList.toggle('no-scroll', open); 
            elements.mainContent.classList.toggle('content-inactive', open);
        };
        openBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); togglePanel(true); });
        closeBtn.addEventListener('click', () => togglePanel(false));
        container.addEventListener('click', (e) => { if (e.target === container) togglePanel(false); });
        scrollTopBtn.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); togglePanel(false); });
        mobileFetchBtn.addEventListener('click', () => { elements.fetchBtn?.click(); togglePanel(false); });
        mobileClearCacheBtn.addEventListener('click', () => { elements.clearCacheBtn?.click(); togglePanel(false); });
    }

    initializeApp();
});
</script>

</body>
</html>
